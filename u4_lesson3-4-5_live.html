<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Topics 4.3â€“4.5: Probability, Mutually Exclusive Events & Conditional Probability</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 880px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            color: #333;
            background: #f9f9f9;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #003366;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .header-left { font-weight: bold; color: #003366; }
        .header-center { font-weight: bold; }
        .header-right { font-weight: bold; color: #003366; }
        h1 { text-align: center; color: #003366; margin-bottom: 5px; font-size: 1.5rem; }
        .subtitle { text-align: center; font-style: italic; color: #555; margin-bottom: 10px; }
        .worksheet-label { text-align: center; font-weight: bold; margin-bottom: 20px; }
        .student-info { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .student-info label { font-weight: bold; }
        .student-info input {
            border: none;
            border-bottom: 1px solid #333;
            background: transparent;
            padding: 2px 5px;
            font-size: 1em;
        }
        .objective-box {
            border: 2px solid #003366;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            background: white;
        }
        .objective-box strong { color: #003366; }
        .vocab-box {
            background: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 25px;
        }
        .vocab-box h3 { margin-top: 0; color: #003366; }
        .vocab-table { width: 100%; }
        .vocab-table td { padding: 5px 0; vertical-align: top; }
        .vocab-table td:first-child { font-weight: bold; width: 180px; color: #003366; }
        .section { margin-bottom: 28px; }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #003366;
            padding-bottom: 6px;
            margin-bottom: 12px;
        }
        .section-header h2 { margin: 0; color: #003366; font-size: 1.15rem; }
        .timestamp { color: #666; font-size: 0.95rem; }
        .question {
            margin-bottom: 12px;
            padding-left: 6px;
            position: relative;
        }
        .question-number {
            font-weight: bold;
            color: #003366;
            margin-right: 8px;
        }
        .sub-questions { margin-left: 22px; margin-top: 6px; }
        .sub-question { margin: 4px 0; }
        .blank {
            border: none;
            border-bottom: 1px solid #003366;
            background: transparent;
            padding: 2px 4px;
            font-size: 1em;
            min-width: 90px;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .blank:focus {
            outline: none;
            border-bottom: 2px solid #003366;
            background: #f0f7ff;
        }
        .blank.correct {
            background-color: #d4edda;
            border-color: #28a745;
        }
        .blank.partial {
            background-color: #fff3cd;
            border-color: #ffc107;
        }
        .blank.incorrect {
            background-color: #f8d7da;
            border-color: #dc3545;
        }
        .blank.revealed {
            background-color: #e2e3f3;
            border-color: #6c757d;
        }
        .model-box, .note-box {
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            background: #fff;
            margin: 10px 0 14px;
        }
        .note-box { background: #f7fbff; border-color: #cce0ff; }
        .hint { color: #777; font-size: 0.92em; margin-left: 6px; }
        textarea {
            width: 100%;
            min-height: 90px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: inherit;
            resize: vertical;
        }
        .exit-ticket {
            border: 2px solid #003366;
            border-radius: 6px;
            padding: 12px;
            background: #f0f4ff;
            margin-top: 18px;
        }

        /* Data reference box */
        .data-reference {
            border: 2px solid #17a2b8;
            border-radius: 8px;
            padding: 15px;
            background: #e8f7fa;
            margin: 15px 0;
        }
        .data-reference h4 {
            margin: 0 0 10px 0;
            color: #117a8b;
        }
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            background: white;
        }
        .data-table th, .data-table td {
            border: 1px solid #ccc;
            padding: 8px 12px;
            text-align: center;
        }
        .data-table th {
            background: #003366;
            color: white;
        }
        .data-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        .data-table .total-row {
            font-weight: bold;
            background: #e9ecef;
        }

        /* Control buttons */
        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .controls button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.95em;
            transition: transform 0.1s, box-shadow 0.2s;
        }
        .controls button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        .btn-check {
            background: #003366;
            color: #fff;
        }
        .btn-show {
            background: #6c757d;
            color: #fff;
        }
        .btn-reset {
            background: #dc3545;
            color: #fff;
        }
        .btn-print {
            background: #28a745;
            color: #fff;
        }
        .btn-ai {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }

        /* AI Feedback Styles */
        .ai-feedback {
            margin-top: 8px;
            padding: 10px;
            background: #f8f9ff;
            border: 1px solid #d0d7ff;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .ai-feedback-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }
        .score-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.85em;
        }
        .score-badge.score-E { background: #d4edda; color: #155724; }
        .score-badge.score-P { background: #fff3cd; color: #856404; }
        .score-badge.score-I { background: #f8d7da; color: #721c24; }

        .ai-feedback-body { color: #444; }
        .ai-feedback-matched { color: #155724; margin-top: 4px; }
        .ai-feedback-missing { color: #856404; margin-top: 4px; }
        .ai-feedback-suggestion { color: #004085; margin-top: 4px; font-style: italic; }

        /* Appeal section */
        .appeal-section { margin-top: 10px; padding-top: 10px; border-top: 1px dashed #ccc; }
        .appeal-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
        }
        .appeal-form {
            display: none;
            margin-top: 8px;
            padding: 10px;
            background: #f8f8f8;
            border-radius: 4px;
        }
        .appeal-form.visible { display: block; }
        .appeal-form textarea {
            min-height: 60px;
            margin: 8px 0;
        }
        .appeal-count { font-size: 0.8em; color: #666; margin-top: 4px; }
        .appeal-result {
            margin-top: 8px;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .appeal-result.upgraded { background: #d4edda; color: #155724; }
        .appeal-result.maintained { background: #fff3cd; color: #856404; }

        textarea.graded-E { border-color: #28a745; background: #f8fff8; }
        textarea.graded-P { border-color: #ffc107; background: #fffdf5; }
        textarea.graded-I { border-color: #dc3545; background: #fff8f8; }

        /* Aggregate drawer */
        .aggregate-drawer {
            position: fixed;
            top: 0;
            right: -380px;
            width: 360px;
            height: 100vh;
            background: #fff;
            box-shadow: -4px 0 20px rgba(0,0,0,0.2);
            transition: right 0.25s ease;
            z-index: 1000;
            overflow-y: auto;
        }
        .aggregate-drawer.open { right: 0; }
        .drawer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: #003366;
            color: #fff;
            position: sticky;
            top: 0;
        }
        .drawer-header h3 { margin: 0; font-size: 1.1em; }
        .drawer-hint { font-size: 0.75em; opacity: 0.8; }
        .drawer-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5em;
            cursor: pointer;
            padding: 0 5px;
        }
        .drawer-content { padding: 16px; }
        .aggregate-trigger {
            background: #e8f0ff;
            border: 1px solid #b8d0ff;
            color: #003366;
            padding: 2px 8px;
            border-radius: 3px;
            cursor: pointer;
            font-size: 0.85em;
            margin-left: 8px;
        }
        .aggregate-trigger:hover { background: #d0e0ff; }

        /* Bar chart styles */
        .bar-chart { margin-top: 10px; }
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid #eee;
        }
        .chart-question-num { font-size: 0.85em; color: #666; }
        .chart-total { font-size: 0.9em; color: #003366; font-weight: bold; }
        .bar-row {
            display: flex;
            align-items: center;
            margin: 6px 0;
            gap: 8px;
        }
        .bar-label {
            width: 80px;
            font-size: 0.85em;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .bar-container {
            flex: 1;
            height: 20px;
            background: #f0f0f0;
            border-radius: 3px;
            overflow: hidden;
        }
        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        .bar-count {
            width: 35px;
            text-align: right;
            font-weight: bold;
            font-size: 0.9em;
        }
        .no-responses { color: #999; font-style: italic; text-align: center; padding: 20px; }

        /* Save indicator */
        .save-indicator {
            position: absolute;
            right: 60px;
            top: 0;
            font-size: 0.8em;
            color: #28a745;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .save-indicator.visible { opacity: 1; }

        /* Upload particle animation */
        .upload-particle {
            color: #667eea;
            font-size: 1.2em;
            animation: uploadFloat 0.9s ease-out forwards;
            pointer-events: none;
        }
        @keyframes uploadFloat {
            0% { transform: translateY(0); opacity: 1; }
            100% { transform: translateY(-40px); opacity: 0; }
        }
        @keyframes snowDrift {
            0% { transform: translateY(0) rotate(0deg); opacity: 1; }
            100% { transform: translateY(60px) rotate(180deg); opacity: 0; }
        }

        #scoreDisplay {
            padding: 4px 12px;
            background: #e8f5e9;
            border-radius: 4px;
            font-weight: bold;
            opacity: 0;
            transition: opacity 0.3s;
        }
        #scoreDisplay.visible { opacity: 1; }

        /* Print styles */
        @media print {
            .controls, .aggregate-trigger, .aggregate-drawer, .save-indicator,
            .appeal-section, .ai-feedback, .btn-ai { display: none !important; }
            .blank { border-bottom: 1px solid #000 !important; background: transparent !important; }
            body { background: white; }
            .section { page-break-inside: avoid; }
            .exit-ticket { page-break-before: auto; }
        }
    </style>
</head>
<body>

    <div class="header">
        <span class="header-left">AP Statistics</span>
        <span class="header-center">Unit 4</span>
        <span class="header-right">Probability & Random Variables</span>
    </div>

    <h1>Topics 4.3â€“4.5: Probability, Mutually Exclusive Events & Conditional Probability</h1>
    <div class="subtitle">Calculating Probabilities, Intersections, and Conditional Events</div>
    <div class="worksheet-label">Video Follow-Along Worksheet</div>

    <div class="student-info">
        <div><label>Name:</label> <input type="text" id="worksheetName" style="width:160px;"></div>
        <div><label>Period:</label> <input type="text" id="worksheetPeriod" style="width:40px;"></div>
        <div><label>Username:</label> <input type="text" id="worksheetUsername" style="width:120px;" placeholder="for class sync"></div>
    </div>

    <div class="controls">
        <button class="btn-check" onclick="checkAnswers()">&#10003; Check Answers</button>
        <button class="btn-show" onclick="showAnswers()">&#128065; Show Answers</button>
        <button class="btn-reset" onclick="resetAnswers()">&#8634; Reset</button>
        <button class="btn-print" onclick="window.print()">&#128424; Print</button>
        <button class="btn-ai" onclick="gradeAllReflections()">&#129302; Grade My Reflections</button>
        <span id="scoreDisplay"></span>
    </div>

    <div class="objective-box">
        <strong>Learning Objectives:</strong>
        <ul style="margin: 8px 0 0 0; padding-left: 20px;">
            <li><strong>VAR-4.A:</strong> Calculate probabilities for events and their complements.</li>
            <li><strong>VAR-4.B:</strong> Interpret probabilities for events.</li>
            <li><strong>VAR-4.C:</strong> Explain why two events are (or are not) mutually exclusive.</li>
            <li><strong>VAR-4.D:</strong> Calculate conditional probabilities.</li>
        </ul>
    </div>

    <div class="vocab-box">
        <h3>Key Vocabulary</h3>
        <table class="vocab-table">
            <tr>
                <td>Sample Space (S)</td>
                <td>The collection of all possible non-overlapping outcomes of a random process</td>
            </tr>
            <tr>
                <td>Probability</td>
                <td>P(A) = (outcomes in A) / (outcomes in sample space); always between 0 and 1</td>
            </tr>
            <tr>
                <td>Complement</td>
                <td>The event that A does <em>not</em> happen, denoted A' or A<sup>c</sup>; P(A') = 1 - P(A)</td>
            </tr>
            <tr>
                <td>Mutually Exclusive</td>
                <td>Events that cannot occur at the same time; P(A âˆ© B) = 0</td>
            </tr>
            <tr>
                <td>Intersection (A âˆ© B)</td>
                <td>The event that both A and B occur; also called joint probability</td>
            </tr>
            <tr>
                <td>Conditional Probability</td>
                <td>P(B|A) = probability of B given that A has occurred = P(A âˆ© B) / P(A)</td>
            </tr>
            <tr>
                <td>Multiplication Rule</td>
                <td>P(A âˆ© B) = P(A) Â· P(B|A)</td>
            </tr>
        </table>
    </div>

    <!-- SECTION 1: Topic 4.3 -->
    <div class="section">
        <div class="section-header">
            <h2>Topic 4.3: Introduction to Probability</h2>
            <span class="timestamp">[Video: ~9 min]</span>
        </div>

        <div class="question">
            <span class="question-number">1.</span>
            For a random process, the <input type="text" class="blank" data-answer="sample space" style="width:110px;"> is the collection of all possible <input type="text" class="blank" data-answer="non-overlapping" style="width:130px;"> outcomes. It is often denoted by the letter <input type="text" class="blank" data-answer="S" style="width:30px;">.
        </div>

        <div class="question">
            <span class="question-number">2.</span>
            <strong>Sample space examples:</strong><br>
            &bull; Flip a single coin: S = {<input type="text" class="blank" data-answer="Heads, Tails|H, T|heads, tails" style="width:120px;">}<br>
            &bull; Roll a single die: S = {<input type="text" class="blank" data-answer="1, 2, 3, 4, 5, 6" style="width:130px;">}
        </div>

        <div class="question">
            <span class="question-number">3.</span>
            If we flip two coins and record the sequence, our sample space has <input type="text" class="blank" data-answer="4|four" style="width:40px;"> outcomes: {HH, HT, TH, TT}.
        </div>

        <div class="question">
            <span class="question-number">4.</span>
            If we roll two dice and record the ordered pair showing on each die, the sample space has <input type="text" class="blank" data-answer="36" style="width:40px;"> possible outcomes.
            <span class="hint">(6 Ã— 6 = ?)</span>
        </div>

        <div class="model-box">
            <strong>Probability Formula (Equally Likely Outcomes):</strong>
            <p style="text-align: center; font-size: 1.1em; margin: 10px 0;">
                P(A) = <span style="display: inline-block; text-align: center; vertical-align: middle;">
                    <span style="border-bottom: 1px solid #333; padding: 0 10px;">number of outcomes in event A</span><br>
                    <span style="padding: 0 10px;">total number of outcomes in sample space</span>
                </span>
            </p>
        </div>

        <div class="question">
            <span class="question-number">5.</span>
            A probability is always a number between <input type="text" class="blank" data-answer="0" style="width:30px;"> and <input type="text" class="blank" data-answer="1" style="width:30px;">, inclusive.
        </div>

        <div class="question">
            <span class="question-number">6.</span>
            A probability of 0 means the event is <input type="text" class="blank" data-answer="impossible" style="width:100px;">. A probability of 1 means it is a <input type="text" class="blank" data-answer="certainty|certain" style="width:90px;">.
        </div>

        <!-- Listen Up! Data Reference -->
        <div class="data-reference">
            <h4>Listen Up! Record Store Data</h4>
            <p>An owner of a record store tracks the genre of vinyl albums sold over the past year:</p>
            <table class="data-table">
                <tr>
                    <th>Genre</th>
                    <th>Rock & Roll</th>
                    <th>Jazz</th>
                    <th>Classical</th>
                    <th>Hip-Hop</th>
                    <th>World</th>
                    <th>Pop</th>
                </tr>
                <tr>
                    <td><strong>Albums Sold</strong></td>
                    <td>327</td>
                    <td>431</td>
                    <td>192</td>
                    <td>790</td>
                    <td>276</td>
                    <td>89</td>
                </tr>
            </table>
            <p style="margin-top: 10px; font-style: italic;">Use this data for questions 7-11.</p>
        </div>

        <div class="question">
            <span class="question-number">7.</span>
            The <strong>random process</strong> is randomly selecting an album sold. The <strong>sample space</strong> is all albums sold, with a total size of <input type="text" class="blank" data-answer="2105|2,105" style="width:60px;"> albums.
        </div>

        <div class="question">
            <span class="question-number">8.</span>
            If Event A = "Select a jazz album," then:<br>
            P(Jazz) = <input type="text" class="blank" data-answer="431" style="width:50px;"> / <input type="text" class="blank" data-answer="2105|2,105" style="width:60px;"> â‰ˆ <input type="text" class="blank" data-answer="0.205|.205|0.20|.20" style="width:60px;">
        </div>

        <div class="question">
            <span class="question-number">9.</span>
            <strong>Interpreting probability:</strong> The probability of an event in a repeatable situation can be interpreted as the <input type="text" class="blank" data-answer="relative frequency" style="width:130px;"> with which the event will occur in the <input type="text" class="blank" data-answer="long run" style="width:80px;">.
        </div>

        <div class="question">
            <span class="question-number">10.</span>
            If we calculate the probability for each genre and add them all up, we should get <input type="text" class="blank" data-answer="1|1.0|one" style="width:40px;">. This confirms we have a valid <input type="text" class="blank" data-answer="probability distribution" style="width:160px;">.
        </div>

        <div class="note-box">
            <strong>Complement Rule:</strong> The complement of event A (denoted A' or A<sup>c</sup>) is the event that A does <em>not</em> happen.<br>
            <strong>P(A') = 1 - P(A)</strong>
        </div>

        <div class="question">
            <span class="question-number">11.</span>
            What is the probability that a randomly selected album is <strong>not</strong> jazz?<br>
            P(not Jazz) = 1 - P(Jazz) = 1 - 0.205 = <input type="text" class="blank" data-answer="0.795|.795" style="width:60px;">
        </div>
    </div>

    <!-- SECTION 2: Topic 4.4 -->
    <div class="section">
        <div class="section-header">
            <h2>Topic 4.4: Mutually Exclusive Events</h2>
            <span class="timestamp">[Video: ~6 min]</span>
        </div>

        <div class="question">
            <span class="question-number">12.</span>
            <input type="text" class="blank" data-answer="Mutually exclusive|mutually exclusive" style="width:150px;"> (or <input type="text" class="blank" data-answer="disjoint" style="width:80px;">) events cannot occur at the same time.
        </div>

        <div class="question">
            <span class="question-number">13.</span>
            In the record store example, each album can only be classified in one genre, so the genres are <input type="text" class="blank" data-answer="mutually exclusive|disjoint" style="width:140px;">.
        </div>

        <div class="note-box">
            <strong>Venn Diagrams:</strong> Circles represent events within a rectangle (sample space). The overlapping region is the <strong>intersection</strong>, denoted A âˆ© B ("A and B").
        </div>

        <div class="question">
            <span class="question-number">14.</span>
            The notation A âˆ© B represents the <input type="text" class="blank" data-answer="intersection" style="width:110px;"> of events A and Bâ€”outcomes that are in <input type="text" class="blank" data-answer="both" style="width:50px;"> A and B.
        </div>

        <div class="question">
            <span class="question-number">15.</span>
            If two events are mutually exclusive, there is <input type="text" class="blank" data-answer="no|no overlap" style="width:80px;"> intersection. The Venn diagram shows two circles that do <input type="text" class="blank" data-answer="not touch|not overlap" style="width:100px;">.
        </div>

        <div class="model-box">
            <strong>Number Cube Example:</strong><br>
            Event A = rolling an odd number: {1, 3, 5}<br>
            Event B = rolling a prime number: {2, 3, 5}<br>
            Event C = rolling an even number: {2, 4, 6}
        </div>

        <div class="question">
            <span class="question-number">16.</span>
            P(A âˆ© B) = probability of rolling a number that is both odd AND prime = <input type="text" class="blank" data-answer="2/6|2 out of 6|1/3" style="width:70px;"> (outcomes: 3 and 5)
        </div>

        <div class="question">
            <span class="question-number">17.</span>
            P(A âˆ© C) = probability of rolling a number that is both odd AND even = <input type="text" class="blank" data-answer="0|0/6|zero" style="width:50px;">. Since P(A âˆ© C) = 0, events A and C are <input type="text" class="blank" data-answer="mutually exclusive|disjoint" style="width:140px;">.
        </div>

        <!-- Super Status! Data Reference -->
        <div class="data-reference">
            <h4>Super Status! Survey Data</h4>
            <p>433 high school students answered: "What superpower would you choose?" and "What status would you prefer?"</p>
            <table class="data-table">
                <tr>
                    <th>Superpower</th>
                    <th>Famous</th>
                    <th>Happy</th>
                    <th>Healthy</th>
                    <th>Rich</th>
                    <th>Total</th>
                </tr>
                <tr>
                    <td><strong>Fly</strong></td>
                    <td>5</td>
                    <td>48</td>
                    <td>14</td>
                    <td>22</td>
                    <td>89</td>
                </tr>
                <tr>
                    <td><strong>Freeze Time</strong></td>
                    <td>3</td>
                    <td>63</td>
                    <td>9</td>
                    <td>26</td>
                    <td>101</td>
                </tr>
                <tr>
                    <td><strong>Invisibility</strong></td>
                    <td>3</td>
                    <td>62</td>
                    <td>11</td>
                    <td>22</td>
                    <td>98</td>
                </tr>
                <tr>
                    <td><strong>Super Strength</strong></td>
                    <td>4</td>
                    <td>43</td>
                    <td>17</td>
                    <td>13</td>
                    <td>77</td>
                </tr>
                <tr>
                    <td><strong>Telepathy</strong></td>
                    <td>0</td>
                    <td>49</td>
                    <td>0</td>
                    <td>19</td>
                    <td>68</td>
                </tr>
                <tr class="total-row">
                    <td><strong>Total</strong></td>
                    <td>15</td>
                    <td>265</td>
                    <td>51</td>
                    <td>102</td>
                    <td>433</td>
                </tr>
            </table>
            <p style="margin-top: 10px; font-style: italic;">Use this data for questions 18-22 and 25-30.</p>
        </div>

        <div class="question">
            <span class="question-number">18.</span>
            P(Happy) = <input type="text" class="blank" data-answer="265" style="width:50px;"> / <input type="text" class="blank" data-answer="433" style="width:50px;"> â‰ˆ <input type="text" class="blank" data-answer="0.612|.612|0.61|.61" style="width:60px;">
        </div>

        <div class="question">
            <span class="question-number">19.</span>
            P(Happy âˆ© Freeze Time) = the <input type="text" class="blank" data-answer="joint|intersection" style="width:90px;"> probability = <input type="text" class="blank" data-answer="63" style="width:40px;"> / 433 â‰ˆ <input type="text" class="blank" data-answer="0.145|.145|0.15|.15" style="width:60px;">
        </div>

        <div class="question">
            <span class="question-number">20.</span>
            P(Famous âˆ© Telepathy) = <input type="text" class="blank" data-answer="0" style="width:30px;"> / 433 = 0. Since this probability is 0, the events "Famous" and "Telepathy" are <input type="text" class="blank" data-answer="mutually exclusive|disjoint" style="width:140px;">.
        </div>

        <div class="note-box">
            <strong>Key Takeaway:</strong> The <strong>joint probability</strong> is the probability of the intersection of two events. Two events are <strong>mutually exclusive</strong> if, and only if, P(A âˆ© B) = 0.
        </div>
    </div>

    <!-- SECTION 3: Topic 4.5 -->
    <div class="section">
        <div class="section-header">
            <h2>Topic 4.5: Conditional Probability</h2>
            <span class="timestamp">[Video: ~8 min]</span>
        </div>

        <div class="question">
            <span class="question-number">21.</span>
            <input type="text" class="blank" data-answer="Conditional probability|conditional probability" style="width:170px;"> is the probability that an event happens <input type="text" class="blank" data-answer="given" style="width:60px;"> that another event is known to have already happened.
        </div>

        <div class="question">
            <span class="question-number">22.</span>
            The notation P(B|A) is read "the probability of <input type="text" class="blank" data-answer="B" style="width:25px;"> given <input type="text" class="blank" data-answer="A" style="width:25px;">."
        </div>

        <div class="model-box">
            <strong>Marble-ous! Example:</strong><br>
            A bag contains 10 marbles (4 fully red, 6 not fully red). You select two marbles <em>without replacement</em>.<br>
            Event A = first marble is fully red<br>
            Event B = second marble is fully red
        </div>

        <div class="question">
            <span class="question-number">23.</span>
            P(A) = probability first marble is red = <input type="text" class="blank" data-answer="4/10|4 out of 10" style="width:80px;">
        </div>

        <div class="question">
            <span class="question-number">24.</span>
            P(B|A) = probability second marble is red, <strong>given</strong> first was red = <input type="text" class="blank" data-answer="3/9|3 out of 9|1/3" style="width:80px;">
            <span class="hint">(Only 3 red left out of 9 remaining)</span>
        </div>

        <div class="note-box">
            <strong>General Multiplication Rule:</strong><br>
            P(A âˆ© B) = P(A) Â· P(B|A)<br><br>
            <em>The probability of both A and B = probability of A Ã— probability of B given A</em>
        </div>

        <div class="question">
            <span class="question-number">25.</span>
            P(both marbles are red) = P(A) Â· P(B|A) = <input type="text" class="blank" data-answer="4/10|4 out of 10" style="width:80px;"> Ã— <input type="text" class="blank" data-answer="3/9|3 out of 9|1/3" style="width:80px;"> = <input type="text" class="blank" data-answer="12/90|0.133|.133" style="width:80px;">
        </div>

        <div class="model-box">
            <strong>Conditional Probability Formula:</strong><br>
            P(B|A) = P(A âˆ© B) / P(A)<br><br>
            <em>This formula can be derived by rearranging the multiplication rule.</em>
        </div>

        <div class="question">
            <span class="question-number">26.</span>
            Using the Super Status! data, find P(Rich | Fly) â€” the probability a student wanted to be rich, given they chose Fly.<br>
            P(Rich | Fly) = P(Rich âˆ© Fly) / P(Fly) = (<input type="text" class="blank" data-answer="22" style="width:35px;">/433) / (<input type="text" class="blank" data-answer="89" style="width:35px;">/433) = <input type="text" class="blank" data-answer="22/89" style="width:60px;">
        </div>

        <div class="question">
            <span class="question-number">27.</span>
            <strong>Shortcut with two-way tables:</strong> For P(Rich | Fly), focus only on the "Fly" row. The answer is simply <input type="text" class="blank" data-answer="22" style="width:35px;"> out of <input type="text" class="blank" data-answer="89" style="width:35px;">.
        </div>

        <div class="note-box">
            <strong>Order Matters!</strong> P(A|B) â‰  P(B|A) in general
        </div>

        <div class="question">
            <span class="question-number">28.</span>
            P(Fly | Rich) = <input type="text" class="blank" data-answer="22" style="width:35px;"> / <input type="text" class="blank" data-answer="102" style="width:40px;">
            <span class="hint">(Focus on the "Rich" column)</span>
        </div>

        <div class="question">
            <span class="question-number">29.</span>
            P(Fly | Not Rich) requires looking at all columns <em>except</em> Rich.<br>
            Students who chose Fly but NOT Rich = <input type="text" class="blank" data-answer="67" style="width:40px;"><br>
            Total students who are NOT Rich = <input type="text" class="blank" data-answer="331" style="width:45px;"><br>
            P(Fly | Not Rich) = <input type="text" class="blank" data-answer="67/331" style="width:70px;">
        </div>

        <div class="question">
            <span class="question-number">30.</span>
            The general multiplication rule P(A âˆ© B) = P(A) Â· P(B|A) can also be written as P(A âˆ© B) = P(<input type="text" class="blank" data-answer="B" style="width:25px;">) Â· P(<input type="text" class="blank" data-answer="A|B|A given B" style="width:60px;">).
        </div>
    </div>

    <!-- REFLECTION SECTION -->
    <div class="section">
        <div class="section-header">
            <h2>Reflection Questions</h2>
            <span class="timestamp">[AI-Graded]</span>
        </div>

        <div class="question">
            <span class="question-number">R1.</span>
            <strong>Using the record store example: If the owner says "About 20% of albums sold are jazz," explain what this probability means in terms of what would happen if we randomly selected many albums. Why is this interpretation more useful than just saying "431 out of 2105"?</strong>
            <textarea id="reflect1" placeholder="Write your response here..."></textarea>
            <div id="reflect1-feedback"></div>
        </div>

        <div class="question">
            <span class="question-number">R2.</span>
            <strong>Explain the difference between mutually exclusive events and events that simply have a low probability of both occurring. Give an example of each using the Super Status! survey data.</strong>
            <textarea id="reflect2" placeholder="Write your response here..."></textarea>
            <div id="reflect2-feedback"></div>
        </div>

        <div class="question">
            <span class="question-number">R3.</span>
            <strong>In the marble example, why does the probability of the second marble being red depend on what happened with the first marble? How would this change if we selected marbles WITH replacement instead?</strong>
            <textarea id="reflect3" placeholder="Write your response here..."></textarea>
            <div id="reflect3-feedback"></div>
        </div>
    </div>

    <!-- EXIT TICKET -->
    <div class="exit-ticket">
        <h3 style="margin-top: 0; color: #003366;">Exit Ticket</h3>
        <div class="question">
            <strong>Problem:</strong> A survey of 200 students asked about their favorite subject (Math or English) and their grade level (Freshman or Sophomore). The results are shown below:
            <table class="data-table" style="width: auto; margin: 10px 0;">
                <tr>
                    <th></th>
                    <th>Math</th>
                    <th>English</th>
                    <th>Total</th>
                </tr>
                <tr>
                    <td><strong>Freshman</strong></td>
                    <td>45</td>
                    <td>55</td>
                    <td>100</td>
                </tr>
                <tr>
                    <td><strong>Sophomore</strong></td>
                    <td>60</td>
                    <td>40</td>
                    <td>100</td>
                </tr>
                <tr class="total-row">
                    <td><strong>Total</strong></td>
                    <td>105</td>
                    <td>95</td>
                    <td>200</td>
                </tr>
            </table>
            <ol style="margin: 8px 0; padding-left: 20px;">
                <li>Calculate P(Math) and interpret what this probability means.</li>
                <li>Calculate P(Freshman âˆ© Math) â€” the joint probability.</li>
                <li>Are "Freshman" and "Math" mutually exclusive? Explain.</li>
                <li>Calculate P(Math | Freshman) and P(Math | Sophomore). What do these tell you?</li>
            </ol>
            <textarea id="exitTicket" placeholder="Write your complete answers here, showing all calculations..."></textarea>
            <div id="exitTicket-feedback"></div>
        </div>
    </div>

    <!-- Aggregate Drawer -->
    <div id="aggregateDrawer" class="aggregate-drawer">
        <div class="drawer-header">
            <h3>Class Responses</h3>
            <span class="drawer-hint">Tab to change input &bull; Esc to close</span>
            <button class="drawer-close" onclick="closeDrawer()">&times;</button>
        </div>
        <div class="drawer-content" id="drawerContent">
            <p>Click a "Class" button next to a question to see responses.</p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../railway_config.js"></script>
    <script src="../railway_client.js"></script>
    <script src="ai-grading-prompts-u4-l345.js"></script>
    <script>
        // ==================== CONFIG ====================
        const UNIT_ID = 'U4L3-5';
        const DEBOUNCE_MS = 250;

        // ==================== STATE ====================
        let debounceMap = new Map();
        let currentFocusedBlank = null;
        let gradingState = new Map();

        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', init);

        function init() {
            ensureRailwayDefaults();
            restoreSavedUser();
            assignQuestionIds();
            addSaveIndicators();
            bindBlankEvents();
            injectAggregateButtons();
            bindGlobalKeys();
        }

        function bindGlobalKeys() {
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    closeDrawer();
                }
            });
        }

        function ensureRailwayDefaults() {
            if (!window.RAILWAY_SERVER_URL) {
                window.RAILWAY_SERVER_URL = 'https://curriculumrender-production.up.railway.app';
            }
        }

        // ==================== USER PERSISTENCE ====================
        function restoreSavedUser() {
            try {
                const saved = localStorage.getItem('worksheet-user');
                if (saved) {
                    const user = JSON.parse(saved);
                    if (user.name) document.getElementById('worksheetName').value = user.name;
                    if (user.klass) document.getElementById('worksheetPeriod').value = user.klass;
                    if (user.username) document.getElementById('worksheetUsername').value = user.username;
                }
            } catch (e) { console.warn('Could not restore user', e); }
        }

        function saveUser() {
            const user = {
                name: document.getElementById('worksheetName').value,
                klass: document.getElementById('worksheetPeriod').value,
                username: document.getElementById('worksheetUsername').value
            };
            localStorage.setItem('worksheet-user', JSON.stringify(user));
        }

        function getUsername() {
            return (document.getElementById('worksheetUsername').value || '').trim();
        }

        document.getElementById('worksheetUsername').addEventListener('blur', saveUser);
        document.getElementById('worksheetName').addEventListener('blur', saveUser);
        document.getElementById('worksheetPeriod').addEventListener('blur', saveUser);

        // ==================== QUESTION IDs & EVENTS ====================
        function assignQuestionIds() {
            const blanks = document.querySelectorAll('.blank');
            blanks.forEach((blank, idx) => {
                blank.dataset.questionId = `WS-${UNIT_ID}-Q${idx + 1}`;
            });
        }

        function addSaveIndicators() {
            document.querySelectorAll('.question').forEach(q => {
                if (!q.querySelector('.save-indicator')) {
                    const indicator = document.createElement('span');
                    indicator.className = 'save-indicator';
                    indicator.textContent = 'âœ“ saved';
                    q.appendChild(indicator);
                }
            });
        }

        function bindBlankEvents() {
            document.querySelectorAll('.blank').forEach(blank => {
                blank.addEventListener('blur', () => handleLiveUpdate(blank));
                blank.addEventListener('focus', () => handleBlankFocus(blank));
                blank.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        handleLiveUpdate(blank);
                        focusNextBlank(blank);
                    }
                });
            });
        }

        function handleBlankFocus(blank) {
            currentFocusedBlank = blank;
            if (document.getElementById('aggregateDrawer').classList.contains('open')) {
                loadAggregateDataForBlank(blank);
            }
        }

        function focusNextBlank(current) {
            const blanks = Array.from(document.querySelectorAll('.blank'));
            const idx = blanks.indexOf(current);
            if (idx >= 0 && idx < blanks.length - 1) {
                blanks[idx + 1].focus();
            }
        }

        // ==================== ANSWER CHECKING ====================
        function normalize(str) {
            return (str || '').toLowerCase().trim().replace(/[^\w\s]/g, '');
        }

        function checkAnswer(blank) {
            const userAnswer = normalize(blank.value);
            const acceptedRaw = blank.dataset.answer || '';
            const accepted = acceptedRaw.split('|').map(normalize);

            blank.classList.remove('correct', 'partial', 'incorrect', 'revealed');

            if (!userAnswer) return 'empty';

            if (accepted.includes(userAnswer)) {
                blank.classList.add('correct');
                return 'correct';
            }

            const partialMatch = accepted.some(ans =>
                userAnswer.includes(ans) || ans.includes(userAnswer)
            );
            if (partialMatch) {
                blank.classList.add('partial');
                return 'partial';
            }

            blank.classList.add('incorrect');
            return 'incorrect';
        }

        function checkAnswers() {
            const blanks = document.querySelectorAll('.blank');
            let correct = 0, partial = 0, total = 0;

            blanks.forEach(blank => {
                if (blank.value.trim()) {
                    total++;
                    const result = checkAnswer(blank);
                    if (result === 'correct') correct++;
                    else if (result === 'partial') partial++;
                }
            });

            const scoreEl = document.getElementById('scoreDisplay');
            if (total > 0) {
                const pct = Math.round((correct / total) * 100);
                scoreEl.textContent = `Score: ${correct}/${total} (${pct}%)` + (partial > 0 ? ` +${partial} partial` : '');
                scoreEl.classList.add('visible');
            } else {
                scoreEl.classList.remove('visible');
            }

            pushAllAnswers();
            refreshDrawerIfOpen();
        }

        function showAnswers() {
            document.querySelectorAll('.blank').forEach(blank => {
                const answers = (blank.dataset.answer || '').split('|');
                blank.value = answers[0] || '';
                blank.classList.remove('correct', 'partial', 'incorrect');
                blank.classList.add('revealed');
            });
            document.getElementById('scoreDisplay').classList.remove('visible');
            pushAllAnswers();
            refreshDrawerIfOpen();
        }

        function resetAnswers() {
            document.querySelectorAll('.blank').forEach(blank => {
                blank.value = '';
                blank.classList.remove('correct', 'partial', 'incorrect', 'revealed');
            });
            document.querySelectorAll('textarea').forEach(ta => {
                ta.value = '';
                ta.classList.remove('graded-E', 'graded-P', 'graded-I');
            });
            document.querySelectorAll('.ai-feedback').forEach(fb => fb.remove());
            document.getElementById('scoreDisplay').classList.remove('visible');
            gradingState.clear();
        }

        // ==================== SERVER SYNC ====================
        function handleLiveUpdate(blank) {
            const questionId = blank.dataset.questionId;
            if (!questionId) return;

            const now = Date.now();
            const lastTime = debounceMap.get(questionId) || 0;
            if (now - lastTime < DEBOUNCE_MS) return;
            debounceMap.set(questionId, now);

            sendAnswer(blank);
        }

        async function sendAnswer(blank) {
            const username = getUsername();
            if (!username) return;

            const questionId = blank.dataset.questionId;
            const answer = blank.value.trim();

            try {
                if (window.railwayClient && window.railwayClient.submitAnswer) {
                    await window.railwayClient.submitAnswer(username, questionId, answer);
                } else {
                    await fetch(`${window.RAILWAY_SERVER_URL}/api/submit-answer`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            username,
                            question_id: questionId,
                            answer_value: answer,
                            timestamp: Date.now()
                        })
                    });
                }
                showSaved(blank);
                spawnUploadParticle(blank);
            } catch (err) {
                console.warn('Failed to sync answer:', err);
            }
        }

        function pushAllAnswers() {
            document.querySelectorAll('.blank').forEach(blank => {
                if (blank.value.trim()) sendAnswer(blank);
            });
        }

        function showSaved(blank) {
            const question = blank.closest('.question');
            if (!question) return;
            const indicator = question.querySelector('.save-indicator');
            if (indicator) {
                indicator.classList.add('visible');
                setTimeout(() => indicator.classList.remove('visible'), 2000);
            }
        }

        function spawnUploadParticle(blank) {
            const particle = document.createElement('span');
            particle.className = 'upload-particle';
            particle.textContent = 'â†‘';
            const rect = blank.getBoundingClientRect();
            particle.style.left = `${rect.left + rect.width / 2}px`;
            particle.style.top = `${rect.top - 5}px`;
            particle.style.position = 'fixed';
            document.body.appendChild(particle);
            setTimeout(() => particle.remove(), 900);
        }

        // ==================== AGGREGATE DRAWER ====================
        function injectAggregateButtons() {
            document.querySelectorAll('.question').forEach(q => {
                const blanks = q.querySelectorAll('.blank');
                if (blanks.length > 0 && !q.querySelector('.aggregate-trigger')) {
                    const btn = document.createElement('button');
                    btn.className = 'aggregate-trigger';
                    btn.textContent = 'ðŸ“Š Class';
                    btn.onclick = () => {
                        const firstBlank = q.querySelector('.blank');
                        if (firstBlank) {
                            openDrawerForBlank(firstBlank);
                        }
                    };
                    q.appendChild(btn);
                }
            });
        }

        function openDrawerForBlank(blank) {
            currentFocusedBlank = blank;
            const drawer = document.getElementById('aggregateDrawer');
            drawer.classList.add('open');
            loadAggregateDataForBlank(blank);
        }

        async function loadAggregateDataForBlank(blank) {
            const content = document.getElementById('drawerContent');
            const questionId = blank.dataset.questionId;

            if (!questionId) {
                content.innerHTML = '<p>No question ID found.</p>';
                return;
            }

            content.innerHTML = '<p>Loading...</p>';

            try {
                const stats = await fetchQuestionStats(questionId);
                content.innerHTML = renderBarChart(questionId, stats, blank);
                spawnPeerSnow();
            } catch (err) {
                content.innerHTML = `<p>Error loading ${questionId}</p>`;
            }
        }

        async function fetchQuestionStats(questionId) {
            if (window.railwayClient && window.railwayClient.getStats) {
                return await window.railwayClient.getStats(questionId);
            }
            const res = await fetch(`${window.RAILWAY_SERVER_URL}/api/question-stats/${questionId}`);
            return await res.json();
        }

        function renderBarChart(questionId, stats, blank) {
            let entries = [];
            let total = 0;
            let isPercentages = false;

            if (stats.responses && Array.isArray(stats.responses)) {
                const groups = new Map();
                stats.responses.forEach(r => {
                    const ans = (r.answer || '').trim();
                    if (!ans) return;
                    groups.set(ans, (groups.get(ans) || 0) + 1);
                });
                entries = Array.from(groups.entries()).sort((a, b) => b[1] - a[1]);
                total = stats.responses.length;
            } else if (stats.distribution) {
                const rawEntries = Object.entries(stats.distribution).filter(([k]) => k && k !== '(blank)');
                const sumValues = rawEntries.reduce((sum, [, v]) => sum + v, 0);

                if (stats.totalResponses && stats.totalResponses > 0) {
                    total = stats.totalResponses;
                    if (sumValues > 0 && sumValues <= 101) {
                        entries = rawEntries.map(([answer, pct]) => [answer, Math.round((pct / 100) * total)]);
                    } else {
                        entries = rawEntries;
                    }
                } else if (sumValues > 0 && sumValues <= 101 && rawEntries.length > 1) {
                    isPercentages = true;
                    total = null;
                    entries = rawEntries;
                } else {
                    total = sumValues;
                    entries = rawEntries;
                }
                entries.sort((a, b) => b[1] - a[1]);
            }

            const maxValue = entries.length > 0 ? entries[0][1] : 0;
            const questionEl = blank ? blank.closest('.question') : null;
            const questionNum = questionEl ? questionEl.querySelector('.question-number')?.textContent : '';

            let html = `<div class="bar-chart">`;
            html += `<div class="chart-header">`;
            html += `<strong>${questionId}</strong>`;
            if (questionNum) {
                html += `<span class="chart-question-num">Question ${questionNum}</span>`;
            }
            if (isPercentages) {
                html += `<span class="chart-total">Distribution</span>`;
            } else if (total !== null) {
                html += `<span class="chart-total">${total} response${total !== 1 ? 's' : ''}</span>`;
            }
            html += `</div>`;

            if (entries.length === 0) {
                html += '<p class="no-responses">No responses yet</p>';
            } else {
                entries.slice(0, 10).forEach(([answer, value]) => {
                    const barWidth = maxValue > 0 ? (value / maxValue) * 100 : 0;
                    const displayValue = isPercentages ? `${Math.round(value)}%` : value;
                    html += `
                        <div class="bar-row">
                            <span class="bar-label" title="${answer}">${answer}</span>
                            <div class="bar-container">
                                <div class="bar-fill" style="width: ${barWidth}%"></div>
                            </div>
                            <span class="bar-count">${displayValue}</span>
                        </div>
                    `;
                });
            }
            html += '</div>';
            return html;
        }

        function closeDrawer() {
            document.getElementById('aggregateDrawer').classList.remove('open');
        }

        function refreshDrawerIfOpen() {
            if (document.getElementById('aggregateDrawer').classList.contains('open') && currentFocusedBlank) {
                loadAggregateDataForBlank(currentFocusedBlank);
            }
        }

        function spawnPeerSnow() {
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    const snow = document.createElement('span');
                    snow.textContent = 'â„';
                    snow.style.cssText = `
                        position: fixed;
                        right: ${20 + Math.random() * 300}px;
                        top: ${100 + Math.random() * 200}px;
                        font-size: 1.2em;
                        color: #90caf9;
                        pointer-events: none;
                        animation: snowDrift 1.4s ease-out forwards;
                    `;
                    document.body.appendChild(snow);
                    setTimeout(() => snow.remove(), 1400);
                }, i * 100);
            }
        }

        // ==================== AI GRADING ====================
        async function gradeAllReflections() {
            const btn = document.querySelector('.btn-ai');
            btn.disabled = true;
            btn.textContent = 'â³ Grading...';

            const textareas = ['reflect1', 'reflect2', 'reflect3', 'exitTicket'];

            for (const id of textareas) {
                const textarea = document.getElementById(id);
                if (!textarea) continue;

                const answer = textarea.value.trim();
                if (answer.length < 20) {
                    showFeedback(id, { score: 'I', feedback: 'Please write a more complete response (at least 20 characters).' });
                    continue;
                }

                try {
                    const result = await gradeReflection(id, answer);
                    gradingState.set(id, {
                        result,
                        originalAnswer: answer,
                        appealCount: 0,
                        history: []
                    });
                    showFeedback(id, result);
                } catch (err) {
                    console.error('Grading error:', err);
                    showFeedback(id, { score: 'I', feedback: 'Error grading response. Please try again.' });
                }
            }

            btn.disabled = false;
            btn.textContent = 'ðŸ¤– Grade My Reflections';
        }

        async function gradeReflection(questionId, answer) {
            if (!window.buildReflectionPromptU4L345) {
                throw new Error('AI grading prompts not loaded');
            }

            const prompt = window.buildReflectionPromptU4L345(questionId, answer);
            const rubric = window.getRubricU4L345(questionId);

            const response = await fetch(`${window.RAILWAY_SERVER_URL}/api/ai/grade`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    scenario: {
                        topic: 'AP Statistics - Probability',
                        questionId,
                        lessonContext: window.LESSON_CONTEXT_U4L345
                    },
                    answers: { answer },
                    prompt
                })
            });

            if (!response.ok) throw new Error('Grading request failed');
            return await response.json();
        }

        function showFeedback(questionId, result) {
            const textarea = document.getElementById(questionId);
            if (!textarea) return;

            textarea.classList.remove('graded-E', 'graded-P', 'graded-I');
            textarea.classList.add(`graded-${result.score}`);

            const container = document.getElementById(`${questionId}-feedback`);
            container.innerHTML = '';

            const feedback = document.createElement('div');
            feedback.className = 'ai-feedback';

            let html = `
                <div class="ai-feedback-header">
                    <span class="score-badge score-${result.score}">${result.score === 'E' ? 'Essentially Correct' : result.score === 'P' ? 'Partially Correct' : 'Incorrect'}</span>
                </div>
                <div class="ai-feedback-body">${result.feedback || ''}</div>
            `;

            if (result.matched && result.matched.length > 0) {
                html += `<div class="ai-feedback-matched">âœ“ You addressed: ${result.matched.join(', ')}</div>`;
            }
            if (result.missing && result.missing.length > 0) {
                html += `<div class="ai-feedback-missing">â—‹ Missing: ${result.missing.join(', ')}</div>`;
            }
            if (result.suggestion) {
                html += `<div class="ai-feedback-suggestion">ðŸ’¡ ${result.suggestion}</div>`;
            }

            feedback.innerHTML = html;

            const state = gradingState.get(questionId);
            if (state && result.score !== 'E' && state.appealCount < 3) {
                const appealSection = document.createElement('div');
                appealSection.className = 'appeal-section';
                appealSection.innerHTML = `
                    <button class="appeal-btn" onclick="showAppealForm('${questionId}')">ðŸ’¬ Disagree? Appeal</button>
                    <div class="appeal-form" id="appeal-form-${questionId}">
                        <p>Explain why your answer deserves a higher score:</p>
                        <textarea id="appeal-text-${questionId}" placeholder="I believe my answer addresses..."></textarea>
                        <button class="btn-check" onclick="submitAppeal('${questionId}')">Submit Appeal</button>
                        <button class="btn-show" onclick="hideAppealForm('${questionId}')">Cancel</button>
                    </div>
                    <div class="appeal-count">Appeals used: ${state.appealCount}/3</div>
                `;
                feedback.appendChild(appealSection);
            }

            container.appendChild(feedback);
        }

        function showAppealForm(questionId) {
            document.getElementById(`appeal-form-${questionId}`).classList.add('visible');
        }

        function hideAppealForm(questionId) {
            document.getElementById(`appeal-form-${questionId}`).classList.remove('visible');
        }

        async function submitAppeal(questionId) {
            const state = gradingState.get(questionId);
            if (!state || state.appealCount >= 3) return;

            const appealText = document.getElementById(`appeal-text-${questionId}`).value.trim();
            if (appealText.length < 10) {
                alert('Please provide more detail in your appeal.');
                return;
            }

            const form = document.getElementById(`appeal-form-${questionId}`);
            const buttons = form.querySelectorAll('button');
            buttons.forEach(b => b.disabled = true);

            try {
                const rubric = window.getRubricU4L345(questionId);
                const response = await fetch(`${window.RAILWAY_SERVER_URL}/api/ai/appeal`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        scenario: {
                            questionId,
                            topic: 'AP Statistics - Probability',
                            prompt: rubric.questionText,
                            expectedElements: rubric.expectedElements.map(e => e.description),
                            lessonContext: window.LESSON_CONTEXT_U4L345
                        },
                        answers: { answer: state.originalAnswer },
                        appealText,
                        previousResults: { answer: state.result }
                    })
                });

                const appealResult = await response.json();
                const previousScore = state.result.score;
                const upgraded = appealResult.score === 'E' ||
                    (previousScore === 'I' && appealResult.score === 'P');

                state.history.push({
                    appealText,
                    previousScore,
                    newScore: appealResult.score,
                    response: appealResult.feedback,
                    upgraded
                });
                state.appealCount++;
                state.result = appealResult;

                showFeedback(questionId, appealResult);

                const resultDiv = document.createElement('div');
                resultDiv.className = `appeal-result ${upgraded ? 'upgraded' : 'maintained'}`;
                resultDiv.textContent = upgraded ? 'ðŸŽ‰ Appeal Granted! Score upgraded.' : 'Score maintained. ' + (appealResult.feedback || '');
                document.getElementById(`${questionId}-feedback`).appendChild(resultDiv);

            } catch (err) {
                console.error('Appeal error:', err);
                alert('Error processing appeal. Please try again.');
            }

            buttons.forEach(b => b.disabled = false);
        }
    </script>
</body>
</html>
