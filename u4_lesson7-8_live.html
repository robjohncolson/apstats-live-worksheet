<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Topics 4.7‚Äì4.8: Random Variables & Probability Distributions</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 880px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            color: #333;
            background: #f9f9f9;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #003366;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .header-left { font-weight: bold; color: #003366; }
        .header-center { font-weight: bold; }
        .header-right { font-weight: bold; color: #003366; }
        h1 { text-align: center; color: #003366; margin-bottom: 5px; font-size: 1.5rem; }
        .subtitle { text-align: center; font-style: italic; color: #555; margin-bottom: 10px; }
        .worksheet-label { text-align: center; font-weight: bold; margin-bottom: 20px; }
        .student-info { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .student-info label { font-weight: bold; }
        .student-info input {
            border: none;
            border-bottom: 1px solid #333;
            background: transparent;
            padding: 2px 5px;
            font-size: 1em;
        }
        .objective-box {
            border: 2px solid #003366;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            background: white;
        }
        .objective-box strong { color: #003366; }
        .vocab-box {
            background: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 25px;
        }
        .vocab-box h3 { margin-top: 0; color: #003366; }
        .vocab-table { width: 100%; }
        .vocab-table td { padding: 5px 0; vertical-align: top; }
        .vocab-table td:first-child { font-weight: bold; width: 180px; color: #003366; }
        .section { margin-bottom: 28px; }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #003366;
            padding-bottom: 6px;
            margin-bottom: 12px;
        }
        .section-header h2 { margin: 0; color: #003366; font-size: 1.15rem; }
        .timestamp { color: #666; font-size: 0.95rem; }
        .question {
            margin-bottom: 12px;
            padding-left: 6px;
            position: relative;
        }
        .question-number {
            font-weight: bold;
            color: #003366;
            margin-right: 8px;
        }
        .sub-questions { margin-left: 22px; margin-top: 6px; }
        .sub-question { margin: 4px 0; }
        .blank {
            border: none;
            border-bottom: 1px solid #003366;
            background: transparent;
            padding: 2px 4px;
            font-size: 1em;
            min-width: 90px;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .blank:focus {
            outline: none;
            border-bottom: 2px solid #003366;
            background: #f0f7ff;
        }
        .blank.correct {
            background-color: #d4edda;
            border-color: #28a745;
        }
        .blank.partial {
            background-color: #fff3cd;
            border-color: #ffc107;
        }
        .blank.incorrect {
            background-color: #f8d7da;
            border-color: #dc3545;
        }
        .blank.revealed {
            background-color: #e2e3f3;
            border-color: #6c757d;
        }
        .model-box, .note-box {
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            background: #fff;
            margin: 10px 0 14px;
        }
        .note-box { background: #f7fbff; border-color: #cce0ff; }
        .hint { color: #777; font-size: 0.92em; margin-left: 6px; }
        textarea {
            width: 100%;
            min-height: 90px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: inherit;
            resize: vertical;
        }
        .exit-ticket {
            border: 2px solid #003366;
            border-radius: 6px;
            padding: 12px;
            background: #f0f4ff;
            margin-top: 18px;
        }

        /* Formula box */
        .formula-box {
            border: 2px solid #667eea;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9ff;
            margin: 15px 0;
            text-align: center;
        }
        .formula-box h4 {
            margin: 0 0 10px 0;
            color: #667eea;
        }
        .formula {
            font-size: 1.2em;
            font-family: 'Times New Roman', serif;
            margin: 8px 0;
        }

        /* Data table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 0.95em;
        }
        .data-table th, .data-table td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
        }
        .data-table th {
            background: #003366;
            color: white;
        }
        .data-table td input {
            width: 60px;
            text-align: center;
        }

        /* Control buttons */
        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .controls button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.95em;
            transition: transform 0.1s, box-shadow 0.2s;
        }
        .controls button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        .btn-check {
            background: #003366;
            color: #fff;
        }
        .btn-show {
            background: #6c757d;
            color: #fff;
        }
        .btn-reset {
            background: #dc3545;
            color: #fff;
        }
        .btn-print {
            background: #28a745;
            color: #fff;
        }
        .btn-ai {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }

        /* AI Feedback Styles */
        .ai-feedback {
            margin-top: 8px;
            padding: 10px;
            background: #f8f9ff;
            border: 1px solid #d0d7ff;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .ai-feedback-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }
        .score-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.85em;
        }
        .score-badge.score-E { background: #d4edda; color: #155724; }
        .score-badge.score-P { background: #fff3cd; color: #856404; }
        .score-badge.score-I { background: #f8d7da; color: #721c24; }

        .ai-feedback-body { color: #444; }
        .ai-feedback-matched { color: #155724; margin-top: 4px; }
        .ai-feedback-missing { color: #856404; margin-top: 4px; }
        .ai-feedback-suggestion { color: #004085; margin-top: 4px; font-style: italic; }

        textarea.graded-E { border-color: #28a745; background: #f8fff9; }
        textarea.graded-P { border-color: #ffc107; background: #fffef5; }
        textarea.graded-I { border-color: #dc3545; background: #fff8f8; }

        /* Appeal system styles */
        .appeal-section { margin-top: 8px; }
        .appeal-btn {
            background: none;
            border: 1px solid #6c757d;
            color: #6c757d;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
        }
        .appeal-btn:hover { background: #f0f0f0; }
        .appeal-form {
            display: none;
            margin-top: 8px;
            padding: 10px;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .appeal-form.visible { display: block; }
        .appeal-form textarea {
            min-height: 60px;
            margin-bottom: 8px;
        }
        .appeal-form button {
            margin-right: 8px;
        }
        .appeal-result {
            margin-top: 8px;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .appeal-result.upgraded { background: #d4edda; color: #155724; }
        .appeal-result.maintained { background: #fff3cd; color: #856404; }
        .appeal-count { font-size: 0.8em; color: #666; margin-top: 4px; }

        /* Score display */
        #scoreDisplay {
            display: none;
            padding: 10px 15px;
            background: #e8f5e9;
            border: 1px solid #4caf50;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        #scoreDisplay.visible {
            display: inline-block;
        }

        /* Aggregate drawer & buttons */
        .aggregate-trigger {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            color: #1565c0;
            padding: 3px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            margin-left: 10px;
        }
        .aggregate-trigger:hover {
            background: #bbdefb;
        }
        .aggregate-drawer {
            position: fixed;
            top: 0;
            right: -380px;
            width: 360px;
            height: 100vh;
            background: #fff;
            box-shadow: -2px 0 10px rgba(0,0,0,0.15);
            transition: right 0.25s ease;
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        .aggregate-drawer.open {
            right: 0;
        }
        .drawer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ccc;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .drawer-header h3 { margin: 0; color: #003366; }
        .drawer-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
        }
        .drawer-content { font-size: 0.95em; }
        .bar-chart { margin: 10px 0; }
        .bar-row {
            display: flex;
            align-items: center;
            margin: 4px 0;
        }
        .bar-label {
            width: 100px;
            font-size: 0.85em;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .bar-container {
            flex: 1;
            height: 18px;
            background: #eee;
            border-radius: 3px;
            overflow: hidden;
            margin: 0 8px;
        }
        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        .bar-count {
            width: 35px;
            text-align: right;
            font-size: 0.85em;
            color: #666;
        }

        /* Save indicator */
        .save-indicator {
            font-size: 0.8em;
            color: #28a745;
            margin-left: 8px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .save-indicator.visible {
            opacity: 1;
        }

        /* Upload particle */
        .upload-particle {
            position: absolute;
            font-size: 0.9em;
            color: #667eea;
            pointer-events: none;
            animation: floatUp 0.9s ease-out forwards;
        }
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-16px); }
        }

        /* Print styles */
        @media print {
            .controls, .aggregate-trigger, .aggregate-drawer, .save-indicator,
            .appeal-section, .ai-feedback, .btn-ai { display: none !important; }
            .blank { border-bottom: 1px solid #000 !important; background: transparent !important; }
            body { background: white; }
            .section { page-break-inside: avoid; }
            .exit-ticket { page-break-before: auto; }
        }
    </style>
</head>
<body>

    <div class="header">
        <span class="header-left">AP Statistics</span>
        <span class="header-center">Unit 4</span>
        <span class="header-right">Probability & Random Variables</span>
    </div>

    <h1>Topics 4.7‚Äì4.8: Random Variables & Probability Distributions</h1>
    <div class="subtitle">Understanding, Calculating, and Interpreting Parameters</div>
    <div class="worksheet-label">Video Follow-Along Worksheet</div>

    <div class="student-info">
        <div><label>Name:</label> <input type="text" id="worksheetName" style="width:160px;"></div>
        <div><label>Period:</label> <input type="text" id="worksheetPeriod" style="width:40px;"></div>
        <div><label>Username:</label> <input type="text" id="worksheetUsername" style="width:120px;" placeholder="for class sync"></div>
    </div>

    <div class="controls">
        <button class="btn-check" onclick="checkAnswers()">&#10003; Check Answers</button>
        <button class="btn-show" onclick="showAnswers()">&#128065; Show Answers</button>
        <button class="btn-reset" onclick="resetAnswers()">&#8634; Reset</button>
        <button class="btn-print" onclick="window.print()">&#128424; Print</button>
        <button class="btn-ai" onclick="gradeAllReflections()">&#129302; Grade My Reflections</button>
        <span id="scoreDisplay"></span>
    </div>

    <div class="objective-box">
        <strong>Learning Objectives:</strong>
        <ul style="margin: 8px 0 0 0; padding-left: 20px;">
            <li><strong>VAR-5.A:</strong> Represent the probability distribution for a discrete random variable.</li>
            <li><strong>VAR-5.B:</strong> Interpret a probability distribution.</li>
            <li><strong>VAR-5.C:</strong> Calculate parameters for a discrete random variable.</li>
            <li><strong>VAR-5.D:</strong> Interpret parameters for a discrete random variable.</li>
        </ul>
    </div>

    <div class="vocab-box">
        <h3>Key Vocabulary</h3>
        <table class="vocab-table">
            <tr>
                <td>Random Variable</td>
                <td>A numerical outcome of random behavior (labeled with capital letters like X, Y)</td>
            </tr>
            <tr>
                <td>Discrete Random Variable</td>
                <td>Can only take a countable number of values (with space between values on a number line)</td>
            </tr>
            <tr>
                <td>Continuous Random Variable</td>
                <td>Can take an infinite number of values in an interval (no space between values)</td>
            </tr>
            <tr>
                <td>Probability Distribution</td>
                <td>A table, graph, or function showing all possible values and their probabilities</td>
            </tr>
            <tr>
                <td>Expected Value (Mean)</td>
                <td>The long-run average value of a random variable: &#956;<sub>X</sub> = &#931;x<sub>i</sub>&#183;P(x<sub>i</sub>)</td>
            </tr>
            <tr>
                <td>Standard Deviation</td>
                <td>Typical deviation from the mean: &#963;<sub>X</sub> = &#8730;[&#931;(x<sub>i</sub> - &#956;<sub>X</sub>)&#178;&#183;P(x<sub>i</sub>)]</td>
            </tr>
        </table>
    </div>

    <!-- SECTION 1: Topic 4.7 Video 1 -->
    <div class="section">
        <div class="section-header">
            <h2>Topic 4.7: Introduction to Random Variables (Video 1)</h2>
            <span class="timestamp">[Video: ~8 min]</span>
        </div>

        <div class="question">
            <span class="question-number">1.</span>
            <input type="text" class="blank" data-answer="random variables|random variable" style="width:140px;"> are numerical outcomes of <input type="text" class="blank" data-answer="random behavior|random" style="width:130px;">.
        </div>

        <div class="question">
            <span class="question-number">2.</span>
            Random variables are always labeled with a <input type="text" class="blank" data-answer="capital|capital letter|uppercase" style="width:100px;"> letter (like X, W, Y, or L).
        </div>

        <div class="question">
            <span class="question-number">3.</span>
            A <input type="text" class="blank" data-answer="discrete" style="width:90px;"> random variable can only take a <input type="text" class="blank" data-answer="countable" style="width:100px;"> number of values. There is <input type="text" class="blank" data-answer="space|space between" style="width:80px;"> between each value on the number line.
        </div>

        <div class="question">
            <span class="question-number">4.</span>
            A <input type="text" class="blank" data-answer="continuous" style="width:100px;"> random variable can take an <input type="text" class="blank" data-answer="infinite" style="width:80px;"> number of values in an interval on the number line.
        </div>

        <div class="question">
            <span class="question-number">5.</span>
            <strong>Classify each variable:</strong>
            <div class="sub-questions">
                <div class="sub-question">X = number of children in a household: <input type="text" class="blank" data-answer="discrete" style="width:90px;"></div>
                <div class="sub-question">W = time in minutes to run a mile: <input type="text" class="blank" data-answer="continuous" style="width:90px;"></div>
                <div class="sub-question">Y = number of dogs with location chip out of 10: <input type="text" class="blank" data-answer="discrete" style="width:90px;"></div>
                <div class="sub-question">L = length of a person's index finger (cm): <input type="text" class="blank" data-answer="continuous" style="width:90px;"></div>
            </div>
        </div>

        <div class="note-box">
            <strong>Thermostat Example:</strong> The City of Austin recommends setting thermostats to 78 degrees. Let X = the number of degrees a thermostat is set below the recommended 78 degrees.
        </div>

        <div class="question">
            <span class="question-number">6.</span>
            A <input type="text" class="blank" data-answer="probability distribution" style="width:160px;"> displays the entire set of values of a random variable with their associated <input type="text" class="blank" data-answer="probabilities|probability" style="width:110px;">.
        </div>

        <div class="model-box">
            <strong>Properties of a Probability Distribution:</strong>
            <ol style="margin: 8px 0; padding-left: 20px;">
                <li>All probabilities are between <input type="text" class="blank" data-answer="0" style="width:30px;"> and <input type="text" class="blank" data-answer="1" style="width:30px;"> inclusive</li>
                <li>The sum of all probabilities must equal <input type="text" class="blank" data-answer="1" style="width:30px;"></li>
            </ol>
        </div>

        <div class="note-box">
            <strong>Thermostat Probability Distribution:</strong>
            <table class="data-table">
                <tr>
                    <th>Temp</th><th>78</th><th>77</th><th>76</th><th>75</th><th>74</th><th>73</th><th>72</th>
                </tr>
                <tr>
                    <th>X</th><td>0</td><td>1</td><td>2</td><td>3</td><td>4</td><td>5</td><td>6</td>
                </tr>
                <tr>
                    <th>P(X)</th><td>0.03</td><td>0.03</td><td>0.05</td><td>0.18</td><td>0.31</td><td>0.28</td><td>0.12</td>
                </tr>
            </table>
        </div>

        <div class="question">
            <span class="question-number">7.</span>
            Using the thermostat distribution, find P(X &#8805; 4) = P(74 degrees or lower):<br>
            P(X &#8805; 4) = <input type="text" class="blank" data-answer="0.31" style="width:50px;"> + <input type="text" class="blank" data-answer="0.28" style="width:50px;"> + <input type="text" class="blank" data-answer="0.12" style="width:50px;"> = <input type="text" class="blank" data-answer="0.71|.71" style="width:50px;">
        </div>
    </div>

    <!-- SECTION 2: Topic 4.7 Video 2 -->
    <div class="section">
        <div class="section-header">
            <h2>Topic 4.7: Describing Probability Distributions (Video 2)</h2>
            <span class="timestamp">[Video: ~5 min]</span>
        </div>

        <div class="note-box">
            <strong>Prairie Dog Example:</strong> Prairie dogs are a keystone species. They mate once a year, and litter size (X = number of pups) varies.
            <table class="data-table" style="margin-top: 10px;">
                <tr>
                    <th>X (pups)</th><th>1</th><th>2</th><th>3</th><th>4</th><th>5</th><th>6</th><th>7</th>
                </tr>
                <tr>
                    <th>P(X)</th><td>0.15</td><td>0.38</td><td>0.27</td><td>0.11</td><td>0.05</td><td>0.03</td><td>0.01</td>
                </tr>
            </table>
        </div>

        <div class="question">
            <span class="question-number">8.</span>
            To describe a probability distribution, we must talk about <input type="text" class="blank" data-answer="shape" style="width:70px;">, <input type="text" class="blank" data-answer="center" style="width:70px;">, and <input type="text" class="blank" data-answer="spread" style="width:70px;">.
        </div>

        <div class="question">
            <span class="question-number">9.</span>
            <strong>Describe the prairie dog pup distribution:</strong>
            <div class="sub-questions">
                <div class="sub-question">Shape: <input type="text" class="blank" data-answer="skewed right|right skewed|skewed to the right" style="width:130px;"></div>
                <div class="sub-question">Center (median): approximately <input type="text" class="blank" data-answer="2" style="width:40px;"> pups</div>
                <div class="sub-question">Spread (range): <input type="text" class="blank" data-answer="6" style="width:40px;"> pups</div>
            </div>
        </div>

        <div class="question">
            <span class="question-number">10.</span>
            Should a zoologist be surprised if a prairie dog had 6 or 7 pups? <input type="text" class="blank" data-answer="yes" style="width:50px;"><br>
            <span class="hint">Calculate: P(X = 6 or X = 7) = <input type="text" class="blank" data-answer="0.04|.04" style="width:50px;"> (relatively unlikely)</span>
        </div>

        <div class="question">
            <span class="question-number">11.</span>
            <strong>Describe the thermostat distribution (from Video 1):</strong>
            <div class="sub-questions">
                <div class="sub-question">Shape: <input type="text" class="blank" data-answer="skewed left|left skewed|skewed to the left" style="width:130px;"></div>
                <div class="sub-question">Center: median temperature is about <input type="text" class="blank" data-answer="74" style="width:40px;"> degrees (X = <input type="text" class="blank" data-answer="4" style="width:30px;">)</div>
                <div class="sub-question">Spread (range): <input type="text" class="blank" data-answer="6" style="width:40px;"> degrees</div>
            </div>
        </div>
    </div>

    <!-- SECTION 3: Topic 4.8 -->
    <div class="section">
        <div class="section-header">
            <h2>Topic 4.8: Mean and Standard Deviation of Random Variables</h2>
            <span class="timestamp">[Video: ~7 min]</span>
        </div>

        <div class="formula-box">
            <h4>Formulas for Parameters of Discrete Random Variables</h4>
            <div class="formula"><strong>Mean (Expected Value):</strong> &#956;<sub>X</sub> = &#931;x<sub>i</sub> &#183; P(x<sub>i</sub>)</div>
            <div class="formula"><strong>Standard Deviation:</strong> &#963;<sub>X</sub> = &#8730;[&#931;(x<sub>i</sub> - &#956;<sub>X</sub>)&#178; &#183; P(x<sub>i</sub>)]</div>
            <div class="formula"><strong>Variance:</strong> &#963;<sub>X</sub>&#178; = &#931;(x<sub>i</sub> - &#956;<sub>X</sub>)&#178; &#183; P(x<sub>i</sub>)</div>
        </div>

        <div class="question">
            <span class="question-number">12.</span>
            A <input type="text" class="blank" data-answer="parameter" style="width:100px;"> is a numerical value measuring a characteristic of a population or distribution. It is a single, <input type="text" class="blank" data-answer="fixed" style="width:60px;"> value.
        </div>

        <div class="question">
            <span class="question-number">13.</span>
            The mean formula takes into account the different <input type="text" class="blank" data-answer="weights|weight" style="width:80px;"> of each X value by multiplying each value by its <input type="text" class="blank" data-answer="probability" style="width:100px;">.
        </div>

        <div class="question">
            <span class="question-number">14.</span>
            <strong>Calculate the mean for prairie dog pups:</strong><br>
            &#956;<sub>X</sub> = 1(0.15) + 2(0.38) + 3(0.27) + 4(0.11) + 5(0.05) + 6(0.03) + 7(0.01) = <input type="text" class="blank" data-answer="2.66" style="width:55px;"> pups
        </div>

        <div class="question">
            <span class="question-number">15.</span>
            <strong>Interpret the mean:</strong> In the <input type="text" class="blank" data-answer="long run" style="width:80px;">, if many prairie dog litters are randomly selected, the <input type="text" class="blank" data-answer="average" style="width:80px;"> number of pups per litter will be about 2.66 pups.
        </div>

        <div class="question">
            <span class="question-number">16.</span>
            The standard deviation for prairie dog pups is calculated to be &#963;<sub>X</sub> = <input type="text" class="blank" data-answer="1.267|1.27" style="width:60px;"> pups.
        </div>

        <div class="question">
            <span class="question-number">17.</span>
            <strong>Interpret the standard deviation:</strong> The number of prairie dog pups in randomly selected litters will generally <input type="text" class="blank" data-answer="vary" style="width:50px;"> from the mean of 2.66 pups by about <input type="text" class="blank" data-answer="1.267|1.27" style="width:60px;"> pups.
        </div>

        <div class="note-box">
            <strong>Insurance Example:</strong> A $25,000 renter's insurance policy costs $150/year.
            <ul style="margin: 5px 0;">
                <li>Theft/vandalism: $3,000 payout, probability 0.0097</li>
                <li>Fire (total loss): $25,000 payout, probability 0.0003</li>
                <li>No claim: 99% of the time</li>
            </ul>
            <table class="data-table" style="margin-top: 10px;">
                <tr>
                    <th>Outcome</th><th>No Claim</th><th>Theft</th><th>Fire</th>
                </tr>
                <tr>
                    <th>X (Profit)</th><td>$150</td><td>-$2,850</td><td>-$24,850</td>
                </tr>
                <tr>
                    <th>P(X)</th><td>0.99</td><td>0.0097</td><td>0.0003</td>
                </tr>
            </table>
        </div>

        <div class="question">
            <span class="question-number">18.</span>
            <strong>Calculate expected profit:</strong><br>
            &#956;<sub>X</sub> = 150(0.99) + (-2850)(0.0097) + (-24850)(0.0003) = $<input type="text" class="blank" data-answer="113.40|113.4" style="width:70px;">
        </div>

        <div class="question">
            <span class="question-number">19.</span>
            <strong>Interpret:</strong> The insurance company can expect to make, on average, about $<input type="text" class="blank" data-answer="113.40|113.4|113" style="width:70px;"> per renter's policy from a large number of randomly selected policies.
        </div>
    </div>

    <!-- REFLECTION SECTION -->
    <div class="section">
        <div class="section-header">
            <h2>Reflection Questions</h2>
            <span class="timestamp">[AI-Graded]</span>
        </div>

        <div class="question">
            <span class="question-number">R1.</span>
            <strong>Explain the difference between a discrete and continuous random variable. Give one original example of each (not from the video) and explain why it fits that category.</strong>
            <textarea id="reflect1" placeholder="Write your response here..."></textarea>
            <div id="reflect1-feedback"></div>
        </div>

        <div class="question">
            <span class="question-number">R2.</span>
            <strong>A game show offers a contestant three doors. Behind one door is $10,000, behind another is $1,000, and behind the third is $0. The contestant picks randomly. Calculate the expected winnings and explain what this value means. Would you recommend playing this game if there's a $3,000 entry fee? Why or why not?</strong>
            <textarea id="reflect2" placeholder="Write your response here..."></textarea>
            <div id="reflect2-feedback"></div>
        </div>
    </div>

    <!-- EXIT TICKET -->
    <div class="exit-ticket">
        <h3 style="margin-top: 0; color: #003366;">Exit Ticket</h3>
        <div class="question">
            <strong>A carnival game costs $2 to play. You roll a fair six-sided die. If you roll a 6, you win $10. If you roll a 1, you win $3. Otherwise, you win nothing.</strong>
            <ul style="margin: 8px 0;">
                <li>Define the random variable X as the player's NET profit (winnings minus cost)</li>
                <li>Create a probability distribution for X</li>
                <li>Calculate the expected value &#956;<sub>X</sub></li>
                <li>Interpret your answer and determine if this is a "fair" game</li>
            </ul>
            <textarea id="exitTicket" placeholder="Show your work and explain your answer..."></textarea>
            <div id="exitTicket-feedback"></div>
        </div>
    </div>

    <!-- Aggregate Drawer -->
    <div id="aggregateDrawer" class="aggregate-drawer">
        <div class="drawer-header">
            <h3>Class Responses <span style="font-size: 0.7em; color: #999; font-weight: normal;">(Esc to close)</span></h3>
            <button class="drawer-close" onclick="closeDrawer()">&times;</button>
        </div>
        <div class="drawer-content" id="drawerContent">
            <p>Click a "Class" button next to a question to see responses.</p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../railway_config.js"></script>
    <script src="../railway_client.js"></script>
    <script src="ai-grading-prompts-u4-l7-8.js"></script>
    <script>
        // ==================== CONFIG ====================
        const UNIT_ID = 'U4L7-8';
        const DEBOUNCE_MS = 250;

        // ==================== STATE ====================
        let debounceMap = new Map();
        let currentQuestionBlanks = [];
        let gradingState = new Map();

        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', init);

        function init() {
            ensureRailwayDefaults();
            restoreSavedUser();
            assignQuestionIds();
            addSaveIndicators();
            bindBlankEvents();
            injectAggregateButtons();
        }

        function ensureRailwayDefaults() {
            if (!window.RAILWAY_SERVER_URL) {
                window.RAILWAY_SERVER_URL = 'https://curriculumrender-production.up.railway.app';
            }
        }

        // ==================== USER PERSISTENCE ====================
        function restoreSavedUser() {
            try {
                const saved = localStorage.getItem('worksheet-user');
                if (saved) {
                    const user = JSON.parse(saved);
                    if (user.name) document.getElementById('worksheetName').value = user.name;
                    if (user.klass) document.getElementById('worksheetPeriod').value = user.klass;
                    if (user.username) document.getElementById('worksheetUsername').value = user.username;
                }
            } catch (e) { console.warn('Could not restore user', e); }
        }

        function saveUser() {
            const user = {
                name: document.getElementById('worksheetName').value,
                klass: document.getElementById('worksheetPeriod').value,
                username: document.getElementById('worksheetUsername').value
            };
            localStorage.setItem('worksheet-user', JSON.stringify(user));
        }

        function getUsername() {
            return (document.getElementById('worksheetUsername').value || '').trim();
        }

        document.getElementById('worksheetUsername').addEventListener('blur', saveUser);
        document.getElementById('worksheetName').addEventListener('blur', saveUser);
        document.getElementById('worksheetPeriod').addEventListener('blur', saveUser);

        // ==================== QUESTION IDs & EVENTS ====================
        function assignQuestionIds() {
            const blanks = document.querySelectorAll('.blank');
            blanks.forEach((blank, idx) => {
                blank.dataset.questionId = `WS-${UNIT_ID}-Q${idx + 1}`;
            });
        }

        function addSaveIndicators() {
            document.querySelectorAll('.question').forEach(q => {
                if (!q.querySelector('.save-indicator')) {
                    const indicator = document.createElement('span');
                    indicator.className = 'save-indicator';
                    indicator.textContent = '‚úì saved';
                    q.appendChild(indicator);
                }
            });
        }

        function bindBlankEvents() {
            document.querySelectorAll('.blank').forEach(blank => {
                blank.addEventListener('blur', () => handleLiveUpdate(blank));
                blank.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        handleLiveUpdate(blank);
                        focusNextBlank(blank);
                    }
                });
            });
        }

        function focusNextBlank(current) {
            const blanks = Array.from(document.querySelectorAll('.blank'));
            const idx = blanks.indexOf(current);
            if (idx >= 0 && idx < blanks.length - 1) {
                blanks[idx + 1].focus();
            }
        }

        // ==================== ANSWER CHECKING ====================
        function normalize(str) {
            return (str || '').toLowerCase().trim().replace(/[^\w\s.]/g, '');
        }

        function checkAnswer(blank) {
            const userAnswer = normalize(blank.value);
            const acceptedRaw = blank.dataset.answer || '';
            const accepted = acceptedRaw.split('|').map(normalize);

            blank.classList.remove('correct', 'partial', 'incorrect', 'revealed');

            if (!userAnswer) return 'empty';

            if (accepted.includes(userAnswer)) {
                blank.classList.add('correct');
                return 'correct';
            }

            const partialMatch = accepted.some(ans =>
                userAnswer.includes(ans) || ans.includes(userAnswer)
            );
            if (partialMatch) {
                blank.classList.add('partial');
                return 'partial';
            }

            blank.classList.add('incorrect');
            return 'incorrect';
        }

        function checkAnswers() {
            const blanks = document.querySelectorAll('.blank');
            let correct = 0, partial = 0, total = 0;

            blanks.forEach(blank => {
                if (blank.value.trim()) {
                    total++;
                    const result = checkAnswer(blank);
                    if (result === 'correct') correct++;
                    else if (result === 'partial') partial++;
                }
            });

            const scoreEl = document.getElementById('scoreDisplay');
            if (total > 0) {
                const pct = Math.round((correct / total) * 100);
                scoreEl.textContent = `Score: ${correct}/${total} (${pct}%)` + (partial > 0 ? ` +${partial} partial` : '');
                scoreEl.classList.add('visible');
            } else {
                scoreEl.classList.remove('visible');
            }

            pushAllAnswers();
            refreshDrawerIfOpen();
        }

        function showAnswers() {
            document.querySelectorAll('.blank').forEach(blank => {
                const answers = (blank.dataset.answer || '').split('|');
                blank.value = answers[0] || '';
                blank.classList.remove('correct', 'partial', 'incorrect');
                blank.classList.add('revealed');
            });
            document.getElementById('scoreDisplay').classList.remove('visible');
            pushAllAnswers();
            refreshDrawerIfOpen();
        }

        function resetAnswers() {
            document.querySelectorAll('.blank').forEach(blank => {
                blank.value = '';
                blank.classList.remove('correct', 'partial', 'incorrect', 'revealed');
            });
            document.querySelectorAll('textarea').forEach(ta => {
                ta.value = '';
                ta.classList.remove('graded-E', 'graded-P', 'graded-I');
            });
            document.querySelectorAll('.ai-feedback').forEach(fb => fb.remove());
            document.getElementById('scoreDisplay').classList.remove('visible');
            gradingState.clear();
        }

        // ==================== SERVER SYNC ====================
        function handleLiveUpdate(blank) {
            const questionId = blank.dataset.questionId;
            if (!questionId) return;

            const now = Date.now();
            const lastTime = debounceMap.get(questionId) || 0;
            if (now - lastTime < DEBOUNCE_MS) return;
            debounceMap.set(questionId, now);

            sendAnswer(blank);
        }

        async function sendAnswer(blank) {
            const username = getUsername();
            if (!username) return;

            const questionId = blank.dataset.questionId;
            const answer = blank.value.trim();

            try {
                if (window.railwayClient && window.railwayClient.submitAnswer) {
                    await window.railwayClient.submitAnswer(username, questionId, answer);
                } else {
                    await fetch(`${window.RAILWAY_SERVER_URL}/api/submit-answer`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            username,
                            question_id: questionId,
                            answer_value: answer,
                            timestamp: Date.now()
                        })
                    });
                }
                showSaved(blank);
                spawnUploadParticle(blank);
            } catch (err) {
                console.warn('Failed to sync answer:', err);
            }
        }

        function pushAllAnswers() {
            document.querySelectorAll('.blank').forEach(blank => {
                if (blank.value.trim()) sendAnswer(blank);
            });
        }

        function showSaved(blank) {
            const question = blank.closest('.question');
            if (!question) return;
            const indicator = question.querySelector('.save-indicator');
            if (indicator) {
                indicator.classList.add('visible');
                setTimeout(() => indicator.classList.remove('visible'), 2000);
            }
        }

        function spawnUploadParticle(blank) {
            const particle = document.createElement('span');
            particle.className = 'upload-particle';
            particle.textContent = '‚Üë';
            const rect = blank.getBoundingClientRect();
            particle.style.left = `${rect.left + rect.width / 2}px`;
            particle.style.top = `${rect.top - 5}px`;
            particle.style.position = 'fixed';
            document.body.appendChild(particle);
            setTimeout(() => particle.remove(), 900);
        }

        // ==================== AGGREGATE DRAWER ====================
        function injectAggregateButtons() {
            document.querySelectorAll('.question').forEach(q => {
                const blanks = q.querySelectorAll('.blank');
                if (blanks.length > 0 && !q.querySelector('.aggregate-trigger')) {
                    const btn = document.createElement('button');
                    btn.className = 'aggregate-trigger';
                    btn.textContent = 'üìä Class';
                    btn.onclick = () => openDrawerForQuestion(q);
                    q.appendChild(btn);
                }
            });
        }

        function openDrawerForQuestion(questionEl) {
            currentQuestionBlanks = Array.from(questionEl.querySelectorAll('.blank'));
            const drawer = document.getElementById('aggregateDrawer');
            const content = document.getElementById('drawerContent');

            drawer.classList.add('open');
            content.innerHTML = '<p>Loading...</p>';

            loadAggregateData();
        }

        async function loadAggregateData() {
            const content = document.getElementById('drawerContent');
            let html = '';

            for (const blank of currentQuestionBlanks) {
                const questionId = blank.dataset.questionId;
                if (!questionId) continue;

                try {
                    const stats = await fetchQuestionStats(questionId);
                    html += renderBarChart(questionId, stats);
                } catch (err) {
                    html += `<p>Error loading ${questionId}</p>`;
                }
            }

            content.innerHTML = html || '<p>No data available.</p>';
            spawnPeerSnow();
        }

        async function fetchQuestionStats(questionId) {
            if (window.railwayClient && window.railwayClient.getStats) {
                return await window.railwayClient.getStats(questionId);
            }
            const res = await fetch(`${window.RAILWAY_SERVER_URL}/api/question-stats/${questionId}`);
            return await res.json();
        }

        function renderBarChart(questionId, stats) {
            const responses = stats.responses || stats.distribution || {};
            const entries = Object.entries(responses).sort((a, b) => b[1] - a[1]);
            const maxCount = entries.length > 0 ? Math.max(...entries.map(([, c]) => c)) : 0;

            if (entries.length === 0) {
                return `<div class="bar-chart"><strong>${questionId}</strong><p>No responses yet</p></div>`;
            }

            let html = `<div class="bar-chart"><strong>${questionId}</strong>`;
            entries.slice(0, 8).forEach(([answer, count]) => {
                // Scale by max count so bars show relative counts, not percentages
                const widthPct = maxCount > 0 ? (count / maxCount) * 100 : 0;
                html += `
                    <div class="bar-row">
                        <span class="bar-label" title="${answer}">${answer}</span>
                        <div class="bar-container">
                            <div class="bar-fill" style="width: ${widthPct}%"></div>
                        </div>
                        <span class="bar-count">${count}</span>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }

        function closeDrawer() {
            document.getElementById('aggregateDrawer').classList.remove('open');
            currentQuestionBlanks = [];
        }

        // Escape key closes drawer
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && document.getElementById('aggregateDrawer').classList.contains('open')) {
                closeDrawer();
            }
        });

        function refreshDrawerIfOpen() {
            if (document.getElementById('aggregateDrawer').classList.contains('open') && currentQuestionBlanks.length > 0) {
                loadAggregateData();
            }
        }

        function spawnPeerSnow() {
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    const snow = document.createElement('span');
                    snow.textContent = '‚ùÑ';
                    snow.style.cssText = `
                        position: fixed;
                        right: ${20 + Math.random() * 300}px;
                        top: ${100 + Math.random() * 200}px;
                        font-size: 1.2em;
                        color: #90caf9;
                        pointer-events: none;
                        animation: snowDrift 1.4s ease-out forwards;
                    `;
                    document.body.appendChild(snow);
                    setTimeout(() => snow.remove(), 1400);
                }, i * 100);
            }
        }

        // ==================== AI GRADING ====================
        async function gradeAllReflections() {
            const btn = document.querySelector('.btn-ai');
            btn.disabled = true;
            btn.textContent = '‚è≥ Grading...';

            const textareas = ['reflect1', 'reflect2', 'exitTicket'];

            for (const id of textareas) {
                const textarea = document.getElementById(id);
                if (!textarea) continue;

                const answer = textarea.value.trim();
                if (answer.length < 20) {
                    showFeedback(id, { score: 'I', feedback: 'Please write a more complete response (at least 20 characters).' });
                    continue;
                }

                try {
                    const result = await gradeReflection(id, answer);
                    gradingState.set(id, {
                        result,
                        originalAnswer: answer,
                        appealCount: 0,
                        history: []
                    });
                    showFeedback(id, result);
                } catch (err) {
                    console.error('Grading error:', err);
                    showFeedback(id, { score: 'I', feedback: 'Error grading response. Please try again.' });
                }
            }

            btn.disabled = false;
            btn.textContent = 'ü§ñ Grade My Reflections';
        }

        async function gradeReflection(questionId, answer) {
            if (!window.buildReflectionPromptU4L78) {
                throw new Error('AI grading prompts not loaded');
            }

            const prompt = window.buildReflectionPromptU4L78(questionId, answer);
            const rubric = window.getRubricU4L78(questionId);

            const response = await fetch(`${window.RAILWAY_SERVER_URL}/api/ai/grade`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    scenario: {
                        topic: 'AP Statistics - Random Variables & Probability Distributions',
                        questionId,
                        lessonContext: window.LESSON_CONTEXT_U4L78
                    },
                    answers: { answer },
                    prompt
                })
            });

            if (!response.ok) throw new Error('Grading request failed');
            return await response.json();
        }

        function showFeedback(questionId, result) {
            const textarea = document.getElementById(questionId);
            if (!textarea) return;

            textarea.classList.remove('graded-E', 'graded-P', 'graded-I');
            textarea.classList.add(`graded-${result.score}`);

            const container = document.getElementById(`${questionId}-feedback`);
            container.innerHTML = '';

            const feedback = document.createElement('div');
            feedback.className = 'ai-feedback';

            let html = `
                <div class="ai-feedback-header">
                    <span class="score-badge score-${result.score}">${result.score === 'E' ? 'Essentially Correct' : result.score === 'P' ? 'Partially Correct' : 'Incorrect'}</span>
                </div>
                <div class="ai-feedback-body">${result.feedback || ''}</div>
            `;

            if (result.matched && result.matched.length > 0) {
                html += `<div class="ai-feedback-matched">‚úì You addressed: ${result.matched.join(', ')}</div>`;
            }
            if (result.missing && result.missing.length > 0) {
                html += `<div class="ai-feedback-missing">‚óã Missing: ${result.missing.join(', ')}</div>`;
            }
            if (result.suggestion) {
                html += `<div class="ai-feedback-suggestion">üí° ${result.suggestion}</div>`;
            }

            feedback.innerHTML = html;

            // Add appeal button if P or I and appeals remaining
            const state = gradingState.get(questionId);
            if (state && result.score !== 'E' && state.appealCount < 3) {
                const appealSection = document.createElement('div');
                appealSection.className = 'appeal-section';
                appealSection.innerHTML = `
                    <button class="appeal-btn" onclick="showAppealForm('${questionId}')">üí¨ Disagree? Appeal</button>
                    <div class="appeal-form" id="appeal-form-${questionId}">
                        <p>Explain why your answer deserves a higher score:</p>
                        <textarea id="appeal-text-${questionId}" placeholder="I believe my answer addresses..."></textarea>
                        <button class="btn-check" onclick="submitAppeal('${questionId}')">Submit Appeal</button>
                        <button class="btn-show" onclick="hideAppealForm('${questionId}')">Cancel</button>
                    </div>
                    <div class="appeal-count">Appeals used: ${state.appealCount}/3</div>
                `;
                feedback.appendChild(appealSection);
            }

            container.appendChild(feedback);
        }

        function showAppealForm(questionId) {
            document.getElementById(`appeal-form-${questionId}`).classList.add('visible');
        }

        function hideAppealForm(questionId) {
            document.getElementById(`appeal-form-${questionId}`).classList.remove('visible');
        }

        async function submitAppeal(questionId) {
            const state = gradingState.get(questionId);
            if (!state || state.appealCount >= 3) return;

            const appealText = document.getElementById(`appeal-text-${questionId}`).value.trim();
            if (appealText.length < 10) {
                alert('Please provide more detail in your appeal.');
                return;
            }

            const form = document.getElementById(`appeal-form-${questionId}`);
            const buttons = form.querySelectorAll('button');
            buttons.forEach(b => b.disabled = true);

            try {
                const rubric = window.getRubricU4L78(questionId);
                const response = await fetch(`${window.RAILWAY_SERVER_URL}/api/ai/appeal`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        scenario: {
                            questionId,
                            topic: 'AP Statistics - Random Variables & Probability Distributions',
                            prompt: rubric.questionText,
                            expectedElements: rubric.expectedElements.map(e => e.description),
                            lessonContext: window.LESSON_CONTEXT_U4L78
                        },
                        answers: { answer: state.originalAnswer },
                        appealText,
                        previousResults: { answer: state.result }
                    })
                });

                const appealResult = await response.json();
                const previousScore = state.result.score;
                const upgraded = appealResult.score === 'E' ||
                    (previousScore === 'I' && appealResult.score === 'P');

                state.history.push({
                    appealText,
                    previousScore,
                    newScore: appealResult.score,
                    response: appealResult.feedback,
                    upgraded
                });
                state.appealCount++;
                state.result = appealResult;

                showFeedback(questionId, appealResult);

                const resultDiv = document.createElement('div');
                resultDiv.className = `appeal-result ${upgraded ? 'upgraded' : 'maintained'}`;
                resultDiv.textContent = upgraded ? 'üéâ Appeal Granted! Score upgraded.' : 'Score maintained. ' + (appealResult.feedback || '');
                document.getElementById(`${questionId}-feedback`).appendChild(resultDiv);

            } catch (err) {
                console.error('Appeal error:', err);
                alert('Error processing appeal. Please try again.');
            }

            buttons.forEach(b => b.disabled = false);
        }
    </script>
</body>
</html>
