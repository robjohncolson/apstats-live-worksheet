<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Topics 4.1‚Äì4.2: Random Patterns & Estimating Probabilities Using Simulation</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 880px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
            color: #333;
            background: #f9f9f9;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #003366;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        .header-left { font-weight: bold; color: #003366; }
        .header-center { font-weight: bold; }
        .header-right { font-weight: bold; color: #003366; }
        h1 { text-align: center; color: #003366; margin-bottom: 5px; font-size: 1.5rem; }
        .subtitle { text-align: center; font-style: italic; color: #555; margin-bottom: 10px; }
        .worksheet-label { text-align: center; font-weight: bold; margin-bottom: 20px; }
        .student-info { display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
        .student-info label { font-weight: bold; }
        .student-info input {
            border: none;
            border-bottom: 1px solid #333;
            background: transparent;
            padding: 2px 5px;
            font-size: 1em;
        }
        .objective-box {
            border: 2px solid #003366;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 20px;
            background: white;
        }
        .objective-box strong { color: #003366; }
        .vocab-box {
            background: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 15px;
            margin-bottom: 25px;
        }
        .vocab-box h3 { margin-top: 0; color: #003366; }
        .vocab-table { width: 100%; }
        .vocab-table td { padding: 5px 0; vertical-align: top; }
        .vocab-table td:first-child { font-weight: bold; width: 180px; color: #003366; }
        .section { margin-bottom: 28px; }
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid #003366;
            padding-bottom: 6px;
            margin-bottom: 12px;
        }
        .section-header h2 { margin: 0; color: #003366; font-size: 1.15rem; }
        .timestamp { color: #666; font-size: 0.95rem; }
        .question {
            margin-bottom: 12px;
            padding-left: 6px;
            position: relative;
        }
        .question-number {
            font-weight: bold;
            color: #003366;
            margin-right: 8px;
        }
        .sub-questions { margin-left: 22px; margin-top: 6px; }
        .sub-question { margin: 4px 0; }
        .blank {
            border: none;
            border-bottom: 1px solid #003366;
            background: transparent;
            padding: 2px 4px;
            font-size: 1em;
            min-width: 90px;
            transition: background-color 0.3s, border-color 0.3s;
        }
        .blank:focus {
            outline: none;
            border-bottom: 2px solid #003366;
            background: #f0f7ff;
        }
        .blank.correct {
            background-color: #d4edda;
            border-color: #28a745;
        }
        .blank.partial {
            background-color: #fff3cd;
            border-color: #ffc107;
        }
        .blank.incorrect {
            background-color: #f8d7da;
            border-color: #dc3545;
        }
        .blank.revealed {
            background-color: #e2e3f3;
            border-color: #6c757d;
        }
        .model-box, .note-box {
            border: 1px solid #ccc;
            border-radius: 5px;
            padding: 10px;
            background: #fff;
            margin: 10px 0 14px;
        }
        .note-box { background: #f7fbff; border-color: #cce0ff; }
        .hint { color: #777; font-size: 0.92em; margin-left: 6px; }
        textarea {
            width: 100%;
            min-height: 90px;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-family: inherit;
            resize: vertical;
        }
        .exit-ticket {
            border: 2px solid #003366;
            border-radius: 6px;
            padding: 12px;
            background: #f0f4ff;
            margin-top: 18px;
        }

        /* Activity box */
        .activity-box {
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9ff;
            margin: 15px 0;
        }
        .activity-box h4 {
            margin: 0 0 10px 0;
            color: #667eea;
        }
        .activity-grid {
            display: grid;
            grid-template-columns: repeat(20, 1fr);
            gap: 2px;
            margin: 10px 0;
        }
        .activity-cell {
            width: 100%;
            aspect-ratio: 1;
            border: 1px solid #ccc;
            text-align: center;
            font-size: 0.7em;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .activity-cell input {
            width: 100%;
            height: 100%;
            border: none;
            text-align: center;
            font-size: 1em;
            text-transform: uppercase;
            background: transparent;
        }
        .activity-cell input:focus {
            background: #e8f0ff;
            outline: 2px solid #003366;
        }
        .activity-summary {
            display: flex;
            gap: 20px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .activity-summary label {
            font-weight: bold;
        }
        .activity-summary input {
            width: 50px;
            border: 1px solid #ccc;
            border-radius: 3px;
            padding: 2px 5px;
            text-align: center;
        }

        /* Control buttons */
        .controls {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .controls button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.95em;
            transition: transform 0.1s, box-shadow 0.2s;
        }
        .controls button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 6px rgba(0,0,0,0.15);
        }
        .btn-check {
            background: #003366;
            color: #fff;
        }
        .btn-show {
            background: #6c757d;
            color: #fff;
        }
        .btn-reset {
            background: #dc3545;
            color: #fff;
        }
        .btn-print {
            background: #28a745;
            color: #fff;
        }
        .btn-ai {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #fff;
        }

        /* AI Feedback Styles */
        .ai-feedback {
            margin-top: 8px;
            padding: 10px;
            background: #f8f9ff;
            border: 1px solid #d0d7ff;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .ai-feedback-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 6px;
        }
        .score-badge {
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
            font-size: 0.85em;
        }
        .score-badge.score-E { background: #d4edda; color: #155724; }
        .score-badge.score-P { background: #fff3cd; color: #856404; }
        .score-badge.score-I { background: #f8d7da; color: #721c24; }

        .ai-feedback-body { color: #444; }
        .ai-feedback-matched { color: #155724; margin-top: 4px; }
        .ai-feedback-missing { color: #856404; margin-top: 4px; }
        .ai-feedback-suggestion { color: #004085; margin-top: 4px; font-style: italic; }

        textarea.graded-E { border-color: #28a745; background: #f8fff9; }
        textarea.graded-P { border-color: #ffc107; background: #fffef5; }
        textarea.graded-I { border-color: #dc3545; background: #fff8f8; }

        /* Appeal system styles */
        .appeal-section { margin-top: 8px; }
        .appeal-btn {
            background: none;
            border: 1px solid #6c757d;
            color: #6c757d;
            padding: 4px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
        }
        .appeal-btn:hover { background: #f0f0f0; }
        .appeal-form {
            display: none;
            margin-top: 8px;
            padding: 10px;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .appeal-form.visible { display: block; }
        .appeal-form textarea {
            min-height: 60px;
            margin-bottom: 8px;
        }
        .appeal-form button {
            margin-right: 8px;
        }
        .appeal-result {
            margin-top: 8px;
            padding: 8px;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .appeal-result.upgraded { background: #d4edda; color: #155724; }
        .appeal-result.maintained { background: #fff3cd; color: #856404; }
        .appeal-count { font-size: 0.8em; color: #666; margin-top: 4px; }

        /* Score display */
        #scoreDisplay {
            display: none;
            padding: 10px 15px;
            background: #e8f5e9;
            border: 1px solid #4caf50;
            border-radius: 4px;
            margin: 10px 0;
            font-weight: bold;
        }
        #scoreDisplay.visible {
            display: inline-block;
        }

        /* Aggregate drawer & buttons */
        .aggregate-trigger {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            color: #1565c0;
            padding: 3px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
            margin-left: 10px;
        }
        .aggregate-trigger:hover {
            background: #bbdefb;
        }
        .aggregate-drawer {
            position: fixed;
            top: 0;
            right: -380px;
            width: 360px;
            height: 100vh;
            background: #fff;
            box-shadow: -2px 0 10px rgba(0,0,0,0.15);
            transition: right 0.25s ease;
            z-index: 1000;
            overflow-y: auto;
            padding: 20px;
        }
        .aggregate-drawer.open {
            right: 0;
        }
        .drawer-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #ccc;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        .drawer-header h3 { margin: 0; color: #003366; }
        .drawer-close {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
        }
        .drawer-content { font-size: 0.95em; }
        .bar-chart { margin: 10px 0; }
        .bar-row {
            display: flex;
            align-items: center;
            margin: 4px 0;
        }
        .bar-label {
            width: 100px;
            font-size: 0.85em;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .bar-container {
            flex: 1;
            height: 18px;
            background: #eee;
            border-radius: 3px;
            overflow: hidden;
            margin: 0 8px;
        }
        .bar-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        .bar-count {
            width: 35px;
            text-align: right;
            font-size: 0.85em;
            color: #666;
        }

        /* Save indicator */
        .save-indicator {
            font-size: 0.8em;
            color: #28a745;
            margin-left: 8px;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .save-indicator.visible {
            opacity: 1;
        }

        /* Upload particle */
        .upload-particle {
            position: absolute;
            font-size: 0.9em;
            color: #667eea;
            pointer-events: none;
            animation: floatUp 0.9s ease-out forwards;
        }
        @keyframes floatUp {
            0% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-16px); }
        }

        /* Print styles */
        @media print {
            .controls, .aggregate-trigger, .aggregate-drawer, .save-indicator,
            .appeal-section, .ai-feedback, .btn-ai { display: none !important; }
            .blank { border-bottom: 1px solid #000 !important; background: transparent !important; }
            body { background: white; }
            .section { page-break-inside: avoid; }
            .exit-ticket { page-break-before: auto; }
        }
    </style>
</head>
<body>

    <div class="header">
        <span class="header-left">AP Statistics</span>
        <span class="header-center">Unit 4</span>
        <span class="header-right">Probability & Random Variables</span>
    </div>

    <h1>Topics 4.1‚Äì4.2: Random Patterns & Estimating Probabilities</h1>
    <div class="subtitle">Introducing Randomness and Simulation</div>
    <div class="worksheet-label">Video Follow-Along Worksheet</div>

    <div class="student-info">
        <div><label>Name:</label> <input type="text" id="worksheetName" style="width:160px;"></div>
        <div><label>Period:</label> <input type="text" id="worksheetPeriod" style="width:40px;"></div>
        <div><label>Username:</label> <input type="text" id="worksheetUsername" style="width:120px;" placeholder="for class sync"></div>
    </div>

    <div class="controls">
        <button class="btn-check" onclick="checkAnswers()">&#10003; Check Answers</button>
        <button class="btn-show" onclick="showAnswers()">&#128065; Show Answers</button>
        <button class="btn-reset" onclick="resetAnswers()">&#8634; Reset</button>
        <button class="btn-print" onclick="window.print()">&#128424; Print</button>
        <button class="btn-ai" onclick="gradeAllReflections()">&#129302; Grade My Reflections</button>
        <span id="scoreDisplay"></span>
    </div>

    <div class="objective-box">
        <strong>Learning Objectives:</strong>
        <ul style="margin: 8px 0 0 0; padding-left: 20px;">
            <li><strong>VAR-1.F:</strong> Identify questions suggested by patterns in data.</li>
            <li><strong>UNC-2.A:</strong> Estimate probabilities using simulation.</li>
        </ul>
    </div>

    <div class="vocab-box">
        <h3>Key Vocabulary</h3>
        <table class="vocab-table">
            <tr>
                <td>Random Process</td>
                <td>A situation where all possible outcomes are known, but individual outcomes are unpredictable</td>
            </tr>
            <tr>
                <td>Outcome</td>
                <td>The result of a single trial of a random process</td>
            </tr>
            <tr>
                <td>Event</td>
                <td>A collection of outcomes from a random process</td>
            </tr>
            <tr>
                <td>Simulation</td>
                <td>A way to model random events such that simulated outcomes closely match real-world outcomes</td>
            </tr>
            <tr>
                <td>Empirical Probability</td>
                <td>Probability estimated by performing many trials and calculating relative frequency</td>
            </tr>
            <tr>
                <td>Law of Large Numbers</td>
                <td>As the number of trials increases, simulated probabilities get closer to the true probability</td>
            </tr>
        </table>
    </div>

    <!-- SECTION 1: Topic 4.1 -->
    <div class="section">
        <div class="section-header">
            <h2>Topic 4.1: Random and Non-Random Patterns</h2>
            <span class="timestamp">[Video: ~5 min]</span>
        </div>

        <div class="question">
            <span class="question-number">1.</span>
            A <input type="text" class="blank" data-answer="random process|random" style="width:130px;"> is a situation where we know all the possible outcomes, but we do not know what the <input type="text" class="blank" data-answer="individual outcome|individual|specific outcome" style="width:140px;"> will be.
        </div>

        <div class="question">
            <span class="question-number">2.</span>
            Although individual outcomes are uncertain, there is a sense of <input type="text" class="blank" data-answer="predictability" style="width:120px;"> that occurs in the <input type="text" class="blank" data-answer="long run" style="width:90px;">.
        </div>

        <div class="activity-box">
            <h4>Give It a Chance! Activity</h4>
            <p>Without flipping a coin, write down a sequence of 100 "random" coin flips (H or T) that you think could come from a fair coin:</p>
            <div class="activity-grid" id="coinGrid">
                <!-- 100 cells for student input, generated by JS -->
            </div>
            <div class="activity-summary">
                <div><label>Total Heads:</label> <input type="text" id="activityHeads"></div>
                <div><label>Total Tails:</label> <input type="text" id="activityTails"></div>
                <div><label>Longest Streak:</label> <input type="text" id="activityStreak"></div>
            </div>
        </div>

        <div class="question">
            <span class="question-number">3.</span>
            In the video's actual 100 coin flips, there were <input type="text" class="blank" data-answer="51" style="width:40px;"> heads and <input type="text" class="blank" data-answer="49" style="width:40px;"> tails.
        </div>

        <div class="question">
            <span class="question-number">4.</span>
            Even if you see 5 tails in a row, this does <strong>not</strong> mean the next flip is "due" to be heads. Each flip is <input type="text" class="blank" data-answer="independent" style="width:110px;">.
        </div>

        <div class="question">
            <span class="question-number">5.</span>
            The longest streak in the video was <input type="text" class="blank" data-answer="8|eight" style="width:40px;"> tails in a row. This may seem non-random, but such streaks are actually <input type="text" class="blank" data-answer="common|likely|normal|expected" style="width:90px;"> in random data.
        </div>

        <div class="note-box">
            <strong>Key Insight:</strong> Patterns in random data (like streaks) may <em>appear</em> non-random, but they are a natural part of random processes. How likely is a streak of 8+? Stay tuned for Topic 4.2!
        </div>
    </div>

    <!-- SECTION 2: Topic 4.2 Video 1 -->
    <div class="section">
        <div class="section-header">
            <h2>Topic 4.2: Estimating Probabilities Using Simulation (Video 1)</h2>
            <span class="timestamp">[Video: ~6 min]</span>
        </div>

        <div class="question">
            <span class="question-number">6.</span>
            An <input type="text" class="blank" data-answer="outcome" style="width:90px;"> is the result of a single trial of a random process.
        </div>

        <div class="question">
            <span class="question-number">7.</span>
            An <input type="text" class="blank" data-answer="event" style="width:70px;"> is a <input type="text" class="blank" data-answer="collection" style="width:90px;"> of outcomes.
            <span class="hint">(Example: rolling a prime number = {2, 3, 5})</span>
        </div>

        <div class="question">
            <span class="question-number">8.</span>
            To find the probability of getting a streak of 8+ heads or tails in 100 flips from just one trial gives us <input type="text" class="blank" data-answer="100|100%" style="width:50px;">%. This is problematic because we only performed <input type="text" class="blank" data-answer="one|1" style="width:50px;"> trial.
        </div>

        <div class="question">
            <span class="question-number">9.</span>
            Due to <input type="text" class="blank" data-answer="variability" style="width:100px;"> in random processes, we need to perform <input type="text" class="blank" data-answer="many" style="width:60px;"> trials to get a reliable estimate.
        </div>

        <div class="question">
            <span class="question-number">10.</span>
            <input type="text" class="blank" data-answer="simulation|a simulation" style="width:100px;"> is a way to model random events such that simulated outcomes closely match <input type="text" class="blank" data-answer="real-world|real world" style="width:100px;"> outcomes.
        </div>

        <div class="question">
            <span class="question-number">11.</span>
            In a simulation of 50 sets of 100 coin flips, a streak of 8+ occurred in <input type="text" class="blank" data-answer="16" style="width:40px;"> out of 50 trials, giving an estimated probability of about <input type="text" class="blank" data-answer="32|32%" style="width:50px;">%.
        </div>
    </div>

    <!-- SECTION 3: Topic 4.2 Video 2 -->
    <div class="section">
        <div class="section-header">
            <h2>Topic 4.2: Estimating Probabilities Using Simulation (Video 2)</h2>
            <span class="timestamp">[Video: ~8 min]</span>
        </div>

        <div class="question">
            <span class="question-number">12.</span>
            The <input type="text" class="blank" data-answer="Law of Large Numbers|law of large numbers" style="width:170px;"> states that simulated probabilities tend to get <input type="text" class="blank" data-answer="closer" style="width:70px;"> to the true probability as the number of trials <input type="text" class="blank" data-answer="increases" style="width:90px;">.
        </div>

        <div class="question">
            <span class="question-number">13.</span>
            In the video's "fair" coin simulation, after 1,000 flips the proportion of heads was around <input type="text" class="blank" data-answer="80|80%|0.80|0.8" style="width:50px;">%. This suggests the coin is <input type="text" class="blank" data-answer="not fair|unfair|biased" style="width:80px;">.
        </div>

        <div class="model-box">
            <strong>Steps to Conduct a Simulation:</strong>
            <ol style="margin: 8px 0; padding-left: 20px;">
                <li>Describe how random digits will imitate the trial (assign digits to outcomes)</li>
                <li>Determine what will be recorded from each trial</li>
                <li>Perform many trials of the simulation</li>
                <li>Calculate the <input type="text" class="blank" data-answer="relative frequency|proportion" style="width:130px;"> of successful trials</li>
            </ol>
        </div>

        <div class="note-box">
            <strong>Sharpshooter Example:</strong> A basketball player makes 82% of her free throws. To break the team record, she must make 16 consecutive shots. Design a simulation to estimate the probability of breaking the record.
        </div>

        <div class="question">
            <span class="question-number">14.</span>
            <strong>Step 1 - Assign digits:</strong><br>
            Using a random number generator (1-100):<br>
            &bull; Numbers <input type="text" class="blank" data-answer="1|01" style="width:35px;"> to <input type="text" class="blank" data-answer="82" style="width:35px;"> represent a <input type="text" class="blank" data-answer="made shot|make|made" style="width:90px;"><br>
            &bull; Numbers <input type="text" class="blank" data-answer="83" style="width:35px;"> to <input type="text" class="blank" data-answer="100" style="width:35px;"> represent a <input type="text" class="blank" data-answer="missed shot|miss|missed" style="width:90px;">
        </div>

        <div class="question">
            <span class="question-number">15.</span>
            <strong>Step 2 - Stopping rule:</strong><br>
            Continue selecting random numbers until a <input type="text" class="blank" data-answer="miss|missed shot|shot is missed" style="width:120px;"> occurs. Count the number of <input type="text" class="blank" data-answer="made shots|makes|made" style="width:100px;">.
        </div>

        <div class="question">
            <span class="question-number">16.</span>
            <strong>Results:</strong> Out of 200 simulated trials, <input type="text" class="blank" data-answer="13" style="width:40px;"> resulted in a streak of 16+ made shots.<br>
            Estimated probability: <input type="text" class="blank" data-answer="13" style="width:35px;"> / <input type="text" class="blank" data-answer="200" style="width:40px;"> = <input type="text" class="blank" data-answer="6.5|6.5%|0.065" style="width:55px;">%
        </div>

        <div class="question">
            <span class="question-number">17.</span>
            If using a <strong>table of random digits</strong> instead, you must use <input type="text" class="blank" data-answer="two|2" style="width:45px;">-digit numbers (01-82 = make, 83-99 and 00 = miss).
        </div>
    </div>

    <!-- REFLECTION SECTION -->
    <div class="section">
        <div class="section-header">
            <h2>Reflection Questions</h2>
            <span class="timestamp">[AI-Graded]</span>
        </div>

        <div class="question">
            <span class="question-number">R1.</span>
            <strong>Explain why your "fake" coin flip sequence (from the activity) might look different from truly random data. What patterns do humans tend to avoid that actually appear in random sequences?</strong>
            <textarea id="reflect1" placeholder="Write your response here..."></textarea>
            <div id="reflect1-feedback"></div>
        </div>

        <div class="question">
            <span class="question-number">R2.</span>
            <strong>A friend says: "I've flipped tails 5 times in a row, so the next flip is almost certain to be heads." Explain why this reasoning is flawed, using the concept of independent events and the Law of Large Numbers.</strong>
            <textarea id="reflect2" placeholder="Write your response here..."></textarea>
            <div id="reflect2-feedback"></div>
        </div>
    </div>

    <!-- EXIT TICKET -->
    <div class="exit-ticket">
        <h3 style="margin-top: 0; color: #003366;">Exit Ticket</h3>
        <div class="question">
            <strong>Design a simulation:</strong> A multiple choice test has 5 questions, each with 4 options (A, B, C, D). A student guesses randomly on every question. Design a simulation to estimate the probability of getting at least 3 correct by guessing.
            <ul style="margin: 8px 0;">
                <li>How would you assign digits to represent outcomes?</li>
                <li>What constitutes one trial?</li>
                <li>What would you record from each trial?</li>
            </ul>
            <textarea id="exitTicket" placeholder="Describe your simulation design..."></textarea>
            <div id="exitTicket-feedback"></div>
        </div>
    </div>

    <!-- Aggregate Drawer -->
    <div id="aggregateDrawer" class="aggregate-drawer">
        <div class="drawer-header">
            <h3>Class Responses</h3>
            <button class="drawer-close" onclick="closeDrawer()">&times;</button>
        </div>
        <div class="drawer-content" id="drawerContent">
            <p>Click a "Class" button next to a question to see responses.</p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../railway_config.js"></script>
    <script src="../railway_client.js"></script>
    <script src="ai-grading-prompts-u4.js"></script>
    <script>
        // ==================== CONFIG ====================
        const UNIT_ID = 'U4L1-2';
        const DEBOUNCE_MS = 250;

        // ==================== STATE ====================
        let debounceMap = new Map();
        let currentQuestionBlanks = [];
        let gradingState = new Map();

        // ==================== INIT ====================
        document.addEventListener('DOMContentLoaded', init);

        function init() {
            ensureRailwayDefaults();
            restoreSavedUser();
            generateCoinGrid();
            assignQuestionIds();
            addSaveIndicators();
            bindBlankEvents();
            injectAggregateButtons();
        }

        function ensureRailwayDefaults() {
            if (!window.RAILWAY_SERVER_URL) {
                window.RAILWAY_SERVER_URL = 'https://curriculumrender-production.up.railway.app';
            }
        }

        function generateCoinGrid() {
            const grid = document.getElementById('coinGrid');
            for (let i = 0; i < 100; i++) {
                const cell = document.createElement('div');
                cell.className = 'activity-cell';
                const input = document.createElement('input');
                input.type = 'text';
                input.maxLength = 1;
                input.dataset.index = i;
                input.addEventListener('input', (e) => {
                    const val = e.target.value.toUpperCase();
                    if (val !== 'H' && val !== 'T' && val !== '') {
                        e.target.value = '';
                    } else {
                        e.target.value = val;
                    }
                    // Auto-advance to next cell
                    if (val && i < 99) {
                        const nextInput = grid.querySelector(`input[data-index="${i + 1}"]`);
                        if (nextInput) nextInput.focus();
                    }
                    updateActivitySummary();
                });
                cell.appendChild(input);
                grid.appendChild(cell);
            }
        }

        function updateActivitySummary() {
            const inputs = document.querySelectorAll('#coinGrid input');
            let heads = 0, tails = 0, maxStreak = 0, currentStreak = 0, lastVal = '';

            inputs.forEach(input => {
                const val = input.value.toUpperCase();
                if (val === 'H') heads++;
                if (val === 'T') tails++;

                if (val && val === lastVal) {
                    currentStreak++;
                } else if (val) {
                    currentStreak = 1;
                }
                if (currentStreak > maxStreak) maxStreak = currentStreak;
                if (val) lastVal = val;
            });

            document.getElementById('activityHeads').value = heads || '';
            document.getElementById('activityTails').value = tails || '';
            document.getElementById('activityStreak').value = maxStreak || '';
        }

        // ==================== USER PERSISTENCE ====================
        function restoreSavedUser() {
            try {
                const saved = localStorage.getItem('worksheet-user');
                if (saved) {
                    const user = JSON.parse(saved);
                    if (user.name) document.getElementById('worksheetName').value = user.name;
                    if (user.klass) document.getElementById('worksheetPeriod').value = user.klass;
                    if (user.username) document.getElementById('worksheetUsername').value = user.username;
                }
            } catch (e) { console.warn('Could not restore user', e); }
        }

        function saveUser() {
            const user = {
                name: document.getElementById('worksheetName').value,
                klass: document.getElementById('worksheetPeriod').value,
                username: document.getElementById('worksheetUsername').value
            };
            localStorage.setItem('worksheet-user', JSON.stringify(user));
        }

        function getUsername() {
            return (document.getElementById('worksheetUsername').value || '').trim();
        }

        document.getElementById('worksheetUsername').addEventListener('blur', saveUser);
        document.getElementById('worksheetName').addEventListener('blur', saveUser);
        document.getElementById('worksheetPeriod').addEventListener('blur', saveUser);

        // ==================== QUESTION IDs & EVENTS ====================
        function assignQuestionIds() {
            const blanks = document.querySelectorAll('.blank');
            blanks.forEach((blank, idx) => {
                blank.dataset.questionId = `WS-${UNIT_ID}-Q${idx + 1}`;
            });
        }

        function addSaveIndicators() {
            document.querySelectorAll('.question').forEach(q => {
                if (!q.querySelector('.save-indicator')) {
                    const indicator = document.createElement('span');
                    indicator.className = 'save-indicator';
                    indicator.textContent = '‚úì saved';
                    q.appendChild(indicator);
                }
            });
        }

        function bindBlankEvents() {
            document.querySelectorAll('.blank').forEach(blank => {
                blank.addEventListener('blur', () => handleLiveUpdate(blank));
                blank.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        handleLiveUpdate(blank);
                        focusNextBlank(blank);
                    }
                });
            });
        }

        function focusNextBlank(current) {
            const blanks = Array.from(document.querySelectorAll('.blank'));
            const idx = blanks.indexOf(current);
            if (idx >= 0 && idx < blanks.length - 1) {
                blanks[idx + 1].focus();
            }
        }

        // ==================== ANSWER CHECKING ====================
        function normalize(str) {
            return (str || '').toLowerCase().trim().replace(/[^\w\s]/g, '');
        }

        function checkAnswer(blank) {
            const userAnswer = normalize(blank.value);
            const acceptedRaw = blank.dataset.answer || '';
            const accepted = acceptedRaw.split('|').map(normalize);

            blank.classList.remove('correct', 'partial', 'incorrect', 'revealed');

            if (!userAnswer) return 'empty';

            if (accepted.includes(userAnswer)) {
                blank.classList.add('correct');
                return 'correct';
            }

            const partialMatch = accepted.some(ans =>
                userAnswer.includes(ans) || ans.includes(userAnswer)
            );
            if (partialMatch) {
                blank.classList.add('partial');
                return 'partial';
            }

            blank.classList.add('incorrect');
            return 'incorrect';
        }

        function checkAnswers() {
            const blanks = document.querySelectorAll('.blank');
            let correct = 0, partial = 0, total = 0;

            blanks.forEach(blank => {
                if (blank.value.trim()) {
                    total++;
                    const result = checkAnswer(blank);
                    if (result === 'correct') correct++;
                    else if (result === 'partial') partial++;
                }
            });

            const scoreEl = document.getElementById('scoreDisplay');
            if (total > 0) {
                const pct = Math.round((correct / total) * 100);
                scoreEl.textContent = `Score: ${correct}/${total} (${pct}%)` + (partial > 0 ? ` +${partial} partial` : '');
                scoreEl.classList.add('visible');
            } else {
                scoreEl.classList.remove('visible');
            }

            pushAllAnswers();
            refreshDrawerIfOpen();
        }

        function showAnswers() {
            document.querySelectorAll('.blank').forEach(blank => {
                const answers = (blank.dataset.answer || '').split('|');
                blank.value = answers[0] || '';
                blank.classList.remove('correct', 'partial', 'incorrect');
                blank.classList.add('revealed');
            });
            document.getElementById('scoreDisplay').classList.remove('visible');
            pushAllAnswers();
            refreshDrawerIfOpen();
        }

        function resetAnswers() {
            document.querySelectorAll('.blank').forEach(blank => {
                blank.value = '';
                blank.classList.remove('correct', 'partial', 'incorrect', 'revealed');
            });
            document.querySelectorAll('textarea').forEach(ta => {
                ta.value = '';
                ta.classList.remove('graded-E', 'graded-P', 'graded-I');
            });
            document.querySelectorAll('.ai-feedback').forEach(fb => fb.remove());
            document.getElementById('scoreDisplay').classList.remove('visible');
            gradingState.clear();
        }

        // ==================== SERVER SYNC ====================
        function handleLiveUpdate(blank) {
            const questionId = blank.dataset.questionId;
            if (!questionId) return;

            const now = Date.now();
            const lastTime = debounceMap.get(questionId) || 0;
            if (now - lastTime < DEBOUNCE_MS) return;
            debounceMap.set(questionId, now);

            sendAnswer(blank);
        }

        async function sendAnswer(blank) {
            const username = getUsername();
            if (!username) return;

            const questionId = blank.dataset.questionId;
            const answer = blank.value.trim();

            try {
                if (window.railwayClient && window.railwayClient.submitAnswer) {
                    await window.railwayClient.submitAnswer(username, questionId, answer);
                } else {
                    await fetch(`${window.RAILWAY_SERVER_URL}/api/submit-answer`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            username,
                            question_id: questionId,
                            answer_value: answer,
                            timestamp: Date.now()
                        })
                    });
                }
                showSaved(blank);
                spawnUploadParticle(blank);
            } catch (err) {
                console.warn('Failed to sync answer:', err);
            }
        }

        function pushAllAnswers() {
            document.querySelectorAll('.blank').forEach(blank => {
                if (blank.value.trim()) sendAnswer(blank);
            });
        }

        function showSaved(blank) {
            const question = blank.closest('.question');
            if (!question) return;
            const indicator = question.querySelector('.save-indicator');
            if (indicator) {
                indicator.classList.add('visible');
                setTimeout(() => indicator.classList.remove('visible'), 2000);
            }
        }

        function spawnUploadParticle(blank) {
            const particle = document.createElement('span');
            particle.className = 'upload-particle';
            particle.textContent = '‚Üë';
            const rect = blank.getBoundingClientRect();
            particle.style.left = `${rect.left + rect.width / 2}px`;
            particle.style.top = `${rect.top - 5}px`;
            particle.style.position = 'fixed';
            document.body.appendChild(particle);
            setTimeout(() => particle.remove(), 900);
        }

        // ==================== AGGREGATE DRAWER ====================
        function injectAggregateButtons() {
            document.querySelectorAll('.question').forEach(q => {
                const blanks = q.querySelectorAll('.blank');
                if (blanks.length > 0 && !q.querySelector('.aggregate-trigger')) {
                    const btn = document.createElement('button');
                    btn.className = 'aggregate-trigger';
                    btn.textContent = 'üìä Class';
                    btn.onclick = () => openDrawerForQuestion(q);
                    q.appendChild(btn);
                }
            });
        }

        function openDrawerForQuestion(questionEl) {
            currentQuestionBlanks = Array.from(questionEl.querySelectorAll('.blank'));
            const drawer = document.getElementById('aggregateDrawer');
            const content = document.getElementById('drawerContent');

            drawer.classList.add('open');
            content.innerHTML = '<p>Loading...</p>';

            loadAggregateData();
        }

        async function loadAggregateData() {
            const content = document.getElementById('drawerContent');
            let html = '';

            for (const blank of currentQuestionBlanks) {
                const questionId = blank.dataset.questionId;
                if (!questionId) continue;

                try {
                    const stats = await fetchQuestionStats(questionId);
                    html += renderBarChart(questionId, stats);
                } catch (err) {
                    html += `<p>Error loading ${questionId}</p>`;
                }
            }

            content.innerHTML = html || '<p>No data available.</p>';
            spawnPeerSnow();
        }

        async function fetchQuestionStats(questionId) {
            if (window.railwayClient && window.railwayClient.getStats) {
                return await window.railwayClient.getStats(questionId);
            }
            const res = await fetch(`${window.RAILWAY_SERVER_URL}/api/question-stats/${questionId}`);
            return await res.json();
        }

        function renderBarChart(questionId, stats) {
            const responses = stats.responses || stats.distribution || {};
            const entries = Object.entries(responses).sort((a, b) => b[1] - a[1]);
            const total = entries.reduce((sum, [, count]) => sum + count, 0);

            if (entries.length === 0) {
                return `<div class="bar-chart"><strong>${questionId}</strong><p>No responses yet</p></div>`;
            }

            let html = `<div class="bar-chart"><strong>${questionId}</strong>`;
            entries.slice(0, 8).forEach(([answer, count]) => {
                const pct = total > 0 ? (count / total) * 100 : 0;
                html += `
                    <div class="bar-row">
                        <span class="bar-label" title="${answer}">${answer}</span>
                        <div class="bar-container">
                            <div class="bar-fill" style="width: ${pct}%"></div>
                        </div>
                        <span class="bar-count">${count}</span>
                    </div>
                `;
            });
            html += '</div>';
            return html;
        }

        function closeDrawer() {
            document.getElementById('aggregateDrawer').classList.remove('open');
            currentQuestionBlanks = [];
        }

        function refreshDrawerIfOpen() {
            if (document.getElementById('aggregateDrawer').classList.contains('open') && currentQuestionBlanks.length > 0) {
                loadAggregateData();
            }
        }

        function spawnPeerSnow() {
            for (let i = 0; i < 5; i++) {
                setTimeout(() => {
                    const snow = document.createElement('span');
                    snow.textContent = '‚ùÑ';
                    snow.style.cssText = `
                        position: fixed;
                        right: ${20 + Math.random() * 300}px;
                        top: ${100 + Math.random() * 200}px;
                        font-size: 1.2em;
                        color: #90caf9;
                        pointer-events: none;
                        animation: snowDrift 1.4s ease-out forwards;
                    `;
                    document.body.appendChild(snow);
                    setTimeout(() => snow.remove(), 1400);
                }, i * 100);
            }
        }

        // ==================== AI GRADING ====================
        async function gradeAllReflections() {
            const btn = document.querySelector('.btn-ai');
            btn.disabled = true;
            btn.textContent = '‚è≥ Grading...';

            const textareas = ['reflect1', 'reflect2', 'exitTicket'];

            for (const id of textareas) {
                const textarea = document.getElementById(id);
                if (!textarea) continue;

                const answer = textarea.value.trim();
                if (answer.length < 20) {
                    showFeedback(id, { score: 'I', feedback: 'Please write a more complete response (at least 20 characters).' });
                    continue;
                }

                try {
                    const result = await gradeReflection(id, answer);
                    gradingState.set(id, {
                        result,
                        originalAnswer: answer,
                        appealCount: 0,
                        history: []
                    });
                    showFeedback(id, result);
                } catch (err) {
                    console.error('Grading error:', err);
                    showFeedback(id, { score: 'I', feedback: 'Error grading response. Please try again.' });
                }
            }

            btn.disabled = false;
            btn.textContent = 'ü§ñ Grade My Reflections';
        }

        async function gradeReflection(questionId, answer) {
            if (!window.buildReflectionPromptU4) {
                throw new Error('AI grading prompts not loaded');
            }

            const prompt = window.buildReflectionPromptU4(questionId, answer);
            const rubric = window.getRubricU4(questionId);

            const response = await fetch(`${window.RAILWAY_SERVER_URL}/api/ai/grade`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    scenario: {
                        topic: 'AP Statistics - Probability & Simulation',
                        questionId,
                        lessonContext: window.LESSON_CONTEXT_U4
                    },
                    answers: { answer },
                    prompt
                })
            });

            if (!response.ok) throw new Error('Grading request failed');
            return await response.json();
        }

        function showFeedback(questionId, result) {
            const textarea = document.getElementById(questionId);
            if (!textarea) return;

            textarea.classList.remove('graded-E', 'graded-P', 'graded-I');
            textarea.classList.add(`graded-${result.score}`);

            const container = document.getElementById(`${questionId}-feedback`);
            container.innerHTML = '';

            const feedback = document.createElement('div');
            feedback.className = 'ai-feedback';

            let html = `
                <div class="ai-feedback-header">
                    <span class="score-badge score-${result.score}">${result.score === 'E' ? 'Essentially Correct' : result.score === 'P' ? 'Partially Correct' : 'Incorrect'}</span>
                </div>
                <div class="ai-feedback-body">${result.feedback || ''}</div>
            `;

            if (result.matched && result.matched.length > 0) {
                html += `<div class="ai-feedback-matched">‚úì You addressed: ${result.matched.join(', ')}</div>`;
            }
            if (result.missing && result.missing.length > 0) {
                html += `<div class="ai-feedback-missing">‚óã Missing: ${result.missing.join(', ')}</div>`;
            }
            if (result.suggestion) {
                html += `<div class="ai-feedback-suggestion">üí° ${result.suggestion}</div>`;
            }

            feedback.innerHTML = html;

            // Add appeal button if P or I and appeals remaining
            const state = gradingState.get(questionId);
            if (state && result.score !== 'E' && state.appealCount < 3) {
                const appealSection = document.createElement('div');
                appealSection.className = 'appeal-section';
                appealSection.innerHTML = `
                    <button class="appeal-btn" onclick="showAppealForm('${questionId}')">üí¨ Disagree? Appeal</button>
                    <div class="appeal-form" id="appeal-form-${questionId}">
                        <p>Explain why your answer deserves a higher score:</p>
                        <textarea id="appeal-text-${questionId}" placeholder="I believe my answer addresses..."></textarea>
                        <button class="btn-check" onclick="submitAppeal('${questionId}')">Submit Appeal</button>
                        <button class="btn-show" onclick="hideAppealForm('${questionId}')">Cancel</button>
                    </div>
                    <div class="appeal-count">Appeals used: ${state.appealCount}/3</div>
                `;
                feedback.appendChild(appealSection);
            }

            container.appendChild(feedback);
        }

        function showAppealForm(questionId) {
            document.getElementById(`appeal-form-${questionId}`).classList.add('visible');
        }

        function hideAppealForm(questionId) {
            document.getElementById(`appeal-form-${questionId}`).classList.remove('visible');
        }

        async function submitAppeal(questionId) {
            const state = gradingState.get(questionId);
            if (!state || state.appealCount >= 3) return;

            const appealText = document.getElementById(`appeal-text-${questionId}`).value.trim();
            if (appealText.length < 10) {
                alert('Please provide more detail in your appeal.');
                return;
            }

            const form = document.getElementById(`appeal-form-${questionId}`);
            const buttons = form.querySelectorAll('button');
            buttons.forEach(b => b.disabled = true);

            try {
                const rubric = window.getRubricU4(questionId);
                const response = await fetch(`${window.RAILWAY_SERVER_URL}/api/ai/appeal`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        scenario: {
                            questionId,
                            topic: 'AP Statistics - Probability & Simulation',
                            prompt: rubric.questionText,
                            expectedElements: rubric.expectedElements.map(e => e.description),
                            lessonContext: window.LESSON_CONTEXT_U4
                        },
                        answers: { answer: state.originalAnswer },
                        appealText,
                        previousResults: { answer: state.result }
                    })
                });

                const appealResult = await response.json();
                const previousScore = state.result.score;
                const upgraded = appealResult.score === 'E' ||
                    (previousScore === 'I' && appealResult.score === 'P');

                state.history.push({
                    appealText,
                    previousScore,
                    newScore: appealResult.score,
                    response: appealResult.feedback,
                    upgraded
                });
                state.appealCount++;
                state.result = appealResult;

                showFeedback(questionId, appealResult);

                const resultDiv = document.createElement('div');
                resultDiv.className = `appeal-result ${upgraded ? 'upgraded' : 'maintained'}`;
                resultDiv.textContent = upgraded ? 'üéâ Appeal Granted! Score upgraded.' : 'Score maintained. ' + (appealResult.feedback || '');
                document.getElementById(`${questionId}-feedback`).appendChild(resultDiv);

            } catch (err) {
                console.error('Appeal error:', err);
                alert('Error processing appeal. Please try again.');
            }

            buttons.forEach(b => b.disabled = false);
        }
    </script>
</body>
</html>
